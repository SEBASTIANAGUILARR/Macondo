<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eventos - Macondo Bar Latino</title>
    <base href="/">
    <link rel="icon" type="image/png" href="favicon.png">
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    <script src="https://unpkg.com/feather-icons"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="components/supabase-client.js"></script>
    <script src="components/navbar.js"></script>
    <script src="components/footer.js"></script>
    <script src="components/auth.js"></script>
    <script src="components/auth-modal.js"></script>
    <script src="components/cart.js"></script>
    <script src="components/orders.js"></script>
    <script src="components/checkout.js"></script>
    <script src="components/user-panel.js"></script>
    <script src="components/analytics-tracker.js"></script>
</head>
<body class="bg-amber-50">
    <custom-navbar></custom-navbar>

    <script>
        try {
            const path = String(window.location.pathname || '').toLowerCase();
            if (path === '/events.html') {
                window.location.replace('/events');
            }
        } catch (e) {}
    </script>

    <main class="container mx-auto px-4 py-8 mt-20">
        <div class="text-center mb-12">
            <h1 class="text-5xl font-bold text-amber-800 mb-4">Eventos</h1>
            <p class="text-xl text-gray-600">Todas nuestras noches especiales, m√∫sica en vivo y experiencias Macondo</p>
        </div>

        <div class="grid lg:grid-cols-3 gap-8">
            <section class="lg:col-span-2">
                <div class="bg-white rounded-lg shadow-md p-6 mb-8">
                    <div class="flex flex-wrap items-start justify-between gap-4">
                        <div>
                            <h2 class="text-2xl font-bold text-amber-800">üéß DJ del finde (S√≥tano)</h2>
                            <p class="text-gray-600 mt-1">Compra tu cover online y recibe tu QR por email.</p>
                            <div class="mt-3 text-sm text-gray-700">
                                <div><strong>DJ:</strong> <span id="cover-dj-name">Dj Micke</span></div>
                                <div><strong>Precio:</strong> <span id="cover-price">30</span> PLN por persona</div>
                            </div>
                        </div>
                        <button type="button" id="cover-open-ticket" class="text-amber-700 hover:text-amber-800 font-bold underline">Ver ticket (con token)</button>
                    </div>

                    <form id="cover-form" class="mt-6 space-y-4">
                        <div class="grid md:grid-cols-3 gap-3">
                            <input id="buyer-name" type="text" placeholder="Nombre comprador" class="p-3 border border-amber-300 rounded-lg" required>
                            <input id="buyer-email" type="email" placeholder="Email comprador" class="p-3 border border-amber-300 rounded-lg" required>
                            <input id="buyer-phone" type="tel" placeholder="Tel√©fono comprador" class="p-3 border border-amber-300 rounded-lg" required>
                        </div>

                        <div class="flex items-center justify-between gap-3">
                            <h3 class="text-lg font-bold text-amber-800">Personas (1 QR por persona)</h3>
                            <button type="button" id="add-person" class="bg-amber-600 hover:bg-amber-700 text-white font-bold px-4 py-2 rounded-lg">+ A√±adir persona</button>
                        </div>

                        <div class="text-sm text-gray-600">Persona #1 = comprador</div>
                        <div id="people-list" class="space-y-3"></div>

                        <label class="flex items-start gap-3 text-sm text-gray-700">
                            <input id="cover-consent-confirm" type="checkbox" required class="mt-1">
                            <span>Acepto usar mis datos para confirmaciones relacionadas con mi compra.</span>
                        </label>

                        <label class="flex items-start gap-3 text-sm text-gray-700">
                            <input id="cover-consent-marketing" type="checkbox" class="mt-1">
                            <span>Acepto recibir informaci√≥n de futuros eventos.</span>
                        </label>

                        <div class="flex flex-wrap items-center justify-between gap-3">
                            <div class="text-sm text-gray-700">
                                Total: <strong><span id="cover-total">0</span> PLN</strong>
                            </div>
                            <button id="cover-submit" type="submit" class="bg-amber-600 hover:bg-amber-700 text-white font-bold py-3 px-6 rounded-lg transition-colors">
                                Comprar Cover (pago online)
                            </button>
                        </div>

                        <div id="cover-status" class="text-sm text-gray-600"></div>
                    </form>
                </div>

                <div id="events-container" class="space-y-8">
                    <p class="text-gray-500 text-center py-8">Cargando eventos...</p>
                </div>
            </section>

            <aside class="lg:col-span-1">
                <div class="bg-white rounded-lg shadow-md p-6 sticky top-24">
                    <h3 class="text-xl font-bold text-amber-800 mb-4">Navegaci√≥n</h3>
                    <div class="space-y-3">
                        <a href="index.html#eventos" class="block w-full text-center bg-amber-600 hover:bg-amber-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">Volver al Home</a>
                        <a href="menu.html" class="block w-full text-center bg-white border border-amber-600 text-amber-700 hover:bg-amber-50 font-bold py-2 px-4 rounded-lg transition-colors">Ver Men√∫ Completo</a>
                    </div>

                    <div class="mt-6">
                        <h4 class="text-lg font-bold text-amber-800 mb-3">Pr√≥ximamente</h4>
                        <ul class="space-y-2 text-gray-700">
                            <li class="flex items-start">
                                <i data-feather="calendar" class="w-4 h-4 mr-2 mt-1 text-amber-700"></i>
                                <span>M√°s noches tem√°ticas cada semana</span>
                            </li>
                            <li class="flex items-start">
                                <i data-feather="music" class="w-4 h-4 mr-2 mt-1 text-amber-700"></i>
                                <span>Sesiones ac√∫sticas y DJ invitados</span>
                            </li>
                            <li class="flex items-start">
                                <i data-feather="users" class="w-4 h-4 mr-2 mt-1 text-amber-700"></i>
                                <span>Eventos privados y caterings</span>
                            </li>
                        </ul>
                    </div>
                </div>
            </aside>
        </div>
    </main>

    <custom-footer></custom-footer>

    <script>
        const supabaseClient = window.supabaseClient;

        let coverConfig = { dj_name: 'Dj Micke', price_pln: 30, active: true };

        function renderPersonRow(index) {
            return `
                <div class="p-4 border border-amber-200 rounded-lg bg-amber-50">
                    <div class="flex items-center justify-between gap-3 mb-3">
                        <div class="font-bold text-amber-800">Persona #${index + 2}</div>
                        <button type="button" class="remove-person text-red-600 hover:text-red-700 font-bold" data-index="${index}">Eliminar</button>
                    </div>
                    <div class="grid md:grid-cols-3 gap-3">
                        <input data-field="name" type="text" placeholder="Nombre" class="p-3 border border-amber-300 rounded-lg" required>
                        <input data-field="email" type="email" placeholder="Email" class="p-3 border border-amber-300 rounded-lg" required>
                        <input data-field="phone" type="tel" placeholder="Tel√©fono" class="p-3 border border-amber-300 rounded-lg" required>
                    </div>
                </div>
            `;
        }

        function updateCoverTotal() {
            const count = 1 + document.querySelectorAll('#people-list > div').length;
            const total = count * Number(coverConfig.price_pln || 0);
            const totalEl = document.getElementById('cover-total');
            if (totalEl) totalEl.textContent = String(total);
        }

        async function loadCoverConfig() {
            try {
                const resp = await fetch('/.netlify/functions/cover-config');
                const data = await resp.json().catch(() => ({}));
                if (resp.ok && data.config) {
                    coverConfig = data.config;
                }

                document.getElementById('cover-dj-name').textContent = coverConfig.dj_name || 'Dj Micke';
                document.getElementById('cover-price').textContent = String(coverConfig.price_pln || 30);
                updateCoverTotal();
            } catch (e) {
                // fallback silencioso
            }
        }

        function addPerson() {
            const list = document.getElementById('people-list');
            if (!list) return;
            const idx = list.children.length;
            const wrapper = document.createElement('div');
            wrapper.innerHTML = renderPersonRow(idx);
            list.appendChild(wrapper.firstElementChild);
            updateCoverTotal();
        }

        function rebuildPersonIndexes() {
            const list = document.getElementById('people-list');
            if (!list) return;
            Array.from(list.children).forEach((child, i) => {
                const title = child.querySelector('.font-bold.text-amber-800');
                if (title) title.textContent = `Persona #${i + 2}`;
                const btn = child.querySelector('.remove-person');
                if (btn) btn.dataset.index = String(i);
            });
            updateCoverTotal();
        }

        // Cargar eventos desde Supabase
        async function loadEvents() {
            const container = document.getElementById('events-container');
            
            const { data: events, error } = await supabaseClient
                .from('events')
                .select('*')
                .eq('activo', true)
                .order('fecha', { ascending: true });
            
            if (error) {
                console.error('Error cargando eventos:', error);
                container.innerHTML = '<p class="text-gray-500 text-center py-8">No se pudieron cargar los eventos.</p>';
                return;
            }
            
            if (!events || events.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-8">No hay eventos programados por el momento.</p>';
                return;
            }
            
            container.innerHTML = events.map(event => `
                <article class="bg-white rounded-lg shadow-md overflow-hidden hover:shadow-lg transition-shadow">
                    ${event.imagen_url ? `<img src="${event.imagen_url}" alt="${event.titulo}" class="w-full h-64 object-cover">` : ''}
                    <div class="p-6">
                        <div class="flex items-center justify-between mb-3 flex-wrap gap-2">
                            <h2 class="text-2xl font-bold text-amber-800">${event.titulo}</h2>
                            <span class="text-sm text-gray-500">${formatEventDate(event.fecha)} ¬∑ ${event.hora || 'Hora por confirmar'}</span>
                        </div>
                        <p class="text-gray-700 mb-4">${event.descripcion || ''}</p>
                        <div class="flex items-center justify-between flex-wrap gap-3">
                            <div class="text-sm text-gray-600">
                                <span class="mr-4">üìç ${event.ubicacion || 'Macondo Bar Latino'}</span>
                                <span>üí∞ ${event.precio || 'Entrada libre'}</span>
                            </div>
                            <div class="flex flex-col sm:flex-row gap-3">
                                <a href="index.html#reservas" class="bg-amber-600 hover:bg-amber-700 text-white font-bold py-2 px-4 rounded-lg transition-colors text-center">Reservar</a>
                            </div>
                        </div>
                    </div>
                </article>
            `).join('');
        }
        
        // Formatear fecha del evento
        function formatEventDate(dateStr) {
            const date = new Date(dateStr);
            const options = { weekday: 'long', day: 'numeric', month: 'long' };
            return date.toLocaleDateString('es-ES', options);
        }

        document.addEventListener('DOMContentLoaded', function() {
            if (typeof feather !== 'undefined') {
                feather.replace();
            }
            
            // Cargar eventos din√°micamente
            loadEvents();

            // Inicializar cover
            loadCoverConfig();
            updateCoverTotal();

            const openTicketBtn = document.getElementById('cover-open-ticket');
            if (openTicketBtn) {
                openTicketBtn.addEventListener('click', () => {
                    const token = prompt('Pega el token del ticket (qr_token):');
                    if (!token) return;
                    window.location.href = `ticket.html?token=${encodeURIComponent(token.trim())}`;
                });
            }

            const addBtn = document.getElementById('add-person');
            if (addBtn) {
                addBtn.addEventListener('click', () => addPerson());
            }

            const peopleList = document.getElementById('people-list');
            if (peopleList) {
                peopleList.addEventListener('click', (e) => {
                    const btn = e.target.closest('.remove-person');
                    if (!btn) return;
                    const idx = Number(btn.dataset.index);
                    const children = Array.from(peopleList.children);
                    if (children[idx]) {
                        children[idx].remove();
                        rebuildPersonIndexes();
                    }
                });
            }

            const coverForm = document.getElementById('cover-form');
            if (coverForm) {
                coverForm.addEventListener('submit', async (e) => {
                    e.preventDefault();

                    const statusEl = document.getElementById('cover-status');
                    const submitBtn = document.getElementById('cover-submit');
                    if (statusEl) statusEl.textContent = '';

                    if (coverConfig.active === false) {
                        if (statusEl) statusEl.textContent = 'Cover no disponible ahora mismo.';
                        return;
                    }

                    const consentConfirm = !!document.getElementById('cover-consent-confirm')?.checked;
                    if (!consentConfirm) {
                        if (statusEl) statusEl.textContent = 'Debes aceptar el consentimiento de confirmaciones para continuar.';
                        return;
                    }

                    const consentMarketing = !!document.getElementById('cover-consent-marketing')?.checked;

                    const buyer_name = document.getElementById('buyer-name').value.trim();
                    const buyer_email = document.getElementById('buyer-email').value.trim();
                    const buyer_phone = document.getElementById('buyer-phone').value.trim();

                    const extraPeople = Array.from(document.querySelectorAll('#people-list > div')).map(row => {
                        return {
                            name: row.querySelector('[data-field="name"]').value.trim(),
                            email: row.querySelector('[data-field="email"]').value.trim(),
                            phone: row.querySelector('[data-field="phone"]').value.trim(),
                        };
                    });

                    if (!buyer_name || !buyer_email || !buyer_phone) {
                        if (statusEl) statusEl.textContent = 'Completa el nombre, email y tel√©fono del comprador.';
                        return;
                    }

                    for (const p of extraPeople) {
                        if (!p.name || !p.email || !p.phone) {
                            if (statusEl) statusEl.textContent = 'Cada persona debe tener nombre, email y tel√©fono.';
                            return;
                        }
                    }

                    const people = [{ name: buyer_name, email: buyer_email, phone: buyer_phone }, ...extraPeople];

                    try {
                        if (submitBtn) {
                            submitBtn.disabled = true;
                            submitBtn.textContent = 'Procesando...';
                        }

                        const resp = await fetch('/.netlify/functions/cover-create-checkout-session', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ buyer_name, buyer_email, buyer_phone, people, consentConfirm, consentMarketing })
                        });

                        const data = await resp.json().catch(() => ({}));
                        if (!resp.ok) {
                            if (statusEl) statusEl.textContent = data.error || 'No se pudo completar la compra.';
                            return;
                        }

                        if (data.url) {
                            window.location.href = data.url;
                            return;
                        }

                        if (statusEl) statusEl.textContent = 'No se pudo iniciar el pago.';
                    } catch (err) {
                        if (statusEl) statusEl.textContent = err.message || String(err);
                    } finally {
                        if (submitBtn) {
                            submitBtn.disabled = false;
                            submitBtn.textContent = 'Comprar Cover (pago online)';
                        }
                    }
                });
            }

            // Mensajes de retorno Stripe
            try {
                const params = new URLSearchParams(window.location.search);
                const ok = params.get('cover_success');
                const cancel = params.get('cover_cancel');
                const statusEl = document.getElementById('cover-status');
                if (ok === '1' && statusEl) {
                    statusEl.textContent = '‚úÖ Pago recibido. Te enviaremos el QR por email en unos momentos.';
                }
                if (cancel === '1' && statusEl) {
                    statusEl.textContent = 'Pago cancelado.';
                }
            } catch (e) {}

            try {
                window.authModal = new AuthModal();
                window.authModal.init();
            } catch (error) {
                console.error('‚ùå Error inicializando AuthModal:', error);
            }

            try {
                window.checkout = new CheckoutSystem();
                window.checkout.init();
            } catch (error) {
                console.error('‚ùå Error inicializando CheckoutSystem:', error);
            }

            try {
                window.userPanel = new UserPanel();
                window.userPanel.init();
            } catch (error) {
                console.error('‚ùå Error inicializando UserPanel:', error);
            }

            if (window.cart && typeof window.cart.updateUI === 'function') {
                window.cart.updateUI();
            }
        });
    </script>
</body>
</html>
