<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Administraci√≥n - Macondo Bar Latino</title>
    <link rel="icon" type="image/png" href="favicon.png">
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        .admin-container {
            min-height: calc(100vh - 100px);
            padding: 2rem;
            background: #fffbeb;
        }
        
        .login-card {
            max-width: 400px;
            margin: 4rem auto;
            background: white;
            border-radius: 1rem;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            padding: 2rem;
        }
        
        .reservation-card {
            background: white;
            border-radius: 0.5rem;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            padding: 1rem;
            margin-bottom: 1rem;
            border-left: 4px solid #d97706;
        }
        
        .reservation-card.confirmada {
            border-left-color: #10b981;
        }
        
        .reservation-card.cancelada {
            border-left-color: #ef4444;
            opacity: 0.7;
        }
        
        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .status-pendiente { background: #fef3c7; color: #92400e; }
        .status-confirmada { background: #d1fae5; color: #065f46; }
        .status-cancelada { background: #fee2e2; color: #991b1b; }
        
        .filter-btn {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 500;
            transition: all 0.2s;
        }
        
        .filter-btn.active {
            background: #d97706;
            color: white;
        }
        
        .filter-btn:not(.active) {
            background: #f3f4f6;
            color: #374151;
        }
        
        .filter-btn:not(.active):hover {
            background: #e5e7eb;
        }
        
        .order-filter-btn {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 500;
            transition: all 0.2s;
        }
        
        .order-filter-btn.active {
            background: #d97706;
            color: white;
        }
        
        .order-filter-btn:not(.active) {
            background: #f3f4f6;
            color: #374151;
        }
        
        .order-filter-btn:not(.active):hover {
            background: #e5e7eb;
        }
        
        .status-preparacion { background: #dbeafe; color: #1e40af; }
        .status-completado { background: #d1fae5; color: #065f46; }
        .status-cancelado { background: #fee2e2; color: #991b1b; }
        
        .menu-filter-btn {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 500;
            transition: all 0.2s;
        }
        
        .menu-filter-btn.active {
            background: #d97706;
            color: white;
        }
        
        .menu-filter-btn:not(.active) {
            background: #f3f4f6;
            color: #374151;
        }
        
        .menu-filter-btn:not(.active):hover {
            background: #e5e7eb;
        }
        
        .analytics-period-btn {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 500;
            transition: all 0.2s;
        }
        
        .analytics-period-btn.active {
            background: #d97706;
            color: white;
        }
        
        .analytics-period-btn:not(.active) {
            background: #f3f4f6;
            color: #374151;
        }
        
        .analytics-period-btn:not(.active):hover {
            background: #e5e7eb;
        }
    </style>
</head>
<body class="bg-amber-50">
    <!-- Header -->
    <header class="bg-amber-800 text-white p-4 shadow-lg">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-2xl font-bold">üçΩÔ∏è Panel de Administraci√≥n</h1>
            <div id="user-info" class="hidden">
                <span id="user-email" class="mr-4"></span>
                <button onclick="logout()" class="bg-amber-600 hover:bg-amber-700 px-3 py-1 sm:px-4 sm:py-2 rounded-lg transition-colors text-sm sm:text-base">
                    Cerrar Sesi√≥n
                </button>
            </div>
        </div>
    </header>

    <!-- Login Form -->
    <div id="login-section" class="admin-container">
        <div class="login-card">
            <h2 class="text-2xl font-bold text-amber-800 mb-6 text-center">Acceso Administrador</h2>
            
            <form id="login-form" class="space-y-4">
                <div>
                    <label class="block text-amber-700 font-medium mb-1">Email</label>
                    <input type="email" id="admin-email" required
                        class="w-full p-3 border border-amber-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500">
                </div>
                
                <div>
                    <label class="block text-amber-700 font-medium mb-1">Contrase√±a</label>
                    <input type="password" id="admin-password" required
                        class="w-full p-3 border border-amber-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500">
                </div>
                
                <div id="login-error" class="hidden text-red-500 text-sm"></div>
                
                <button type="submit" class="w-full bg-amber-600 hover:bg-amber-700 text-white font-bold py-3 rounded-lg transition-colors">
                    Iniciar Sesi√≥n
                </button>
            </form>
            
            <p class="mt-4 text-center text-gray-500 text-sm">
                Solo usuarios autorizados pueden acceder.
            </p>
        </div>
    </div>

    <div id="manual-reservation-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-lg w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-amber-800">Agregar Reserva Manual</h3>
                    <button type="button" onclick="closeManualReservationModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
                </div>

                <form id="manual-reservation-form" class="space-y-4">
                    <div>
                        <label class="block text-amber-700 font-medium mb-1">Nombre *</label>
                        <input type="text" id="manual-reservation-nombre" required class="w-full p-3 border border-amber-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500" placeholder="Nombre completo">
                    </div>

                    <div>
                        <label class="block text-amber-700 font-medium mb-1">Email *</label>
                        <input type="email" id="manual-reservation-email" required class="w-full p-3 border border-amber-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500" placeholder="cliente@email.com">
                    </div>

                    <div>
                        <label class="block text-amber-700 font-medium mb-1">Tel√©fono</label>
                        <input type="tel" id="manual-reservation-telefono" class="w-full p-3 border border-amber-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500" placeholder="+48 ...">
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-amber-700 font-medium mb-1">Fecha *</label>
                            <input type="date" id="manual-reservation-fecha" required class="w-full p-3 border border-amber-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500">
                        </div>
                        <div>
                            <label class="block text-amber-700 font-medium mb-1">Hora</label>
                            <input type="time" id="manual-reservation-hora" class="w-full p-3 border border-amber-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500">
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-amber-700 font-medium mb-1">Personas *</label>
                            <input type="number" id="manual-reservation-personas" required min="1" step="1" value="2" class="w-full p-3 border border-amber-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500">
                        </div>
                        <div>
                            <label class="block text-amber-700 font-medium mb-1">Mesa</label>
                            <input type="text" id="manual-reservation-mesa" class="w-full p-3 border border-amber-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500" placeholder="Ej: 4">
                        </div>
                    </div>

                    <div>
                        <label class="block text-amber-700 font-medium mb-1">Comentarios</label>
                        <textarea id="manual-reservation-comentarios" rows="3" class="w-full p-3 border border-amber-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500" placeholder="Notas..." ></textarea>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-amber-700 font-medium mb-1">Estado *</label>
                            <select id="manual-reservation-estado" required class="w-full p-3 border border-amber-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500">
                                <option value="pendiente">pendiente</option>
                                <option value="confirmada" selected>confirmada</option>
                                <option value="cancelada">cancelada</option>
                            </select>
                        </div>
                        <div class="flex items-center gap-2">
                            <input type="checkbox" id="manual-reservation-send-email" class="w-5 h-5 text-amber-600 border-amber-300 rounded focus:ring-amber-500" checked>
                            <label for="manual-reservation-send-email" class="text-amber-700">Enviar email</label>
                        </div>
                    </div>

                    <div class="flex gap-3 pt-2">
                        <button type="button" onclick="closeManualReservationModal()" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-3 rounded-lg transition-colors">Cancelar</button>
                        <button type="submit" class="flex-1 bg-amber-600 hover:bg-amber-700 text-white font-bold py-3 rounded-lg transition-colors">Guardar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Admin Panel -->
    <div id="admin-panel" class="admin-container hidden">
        <div class="container mx-auto">
            <!-- Tabs -->
            <div class="sm:hidden mb-4">
                <label for="mobile-tab-select" class="block text-sm font-bold text-amber-800 mb-2">Secci√≥n</label>
                <select id="mobile-tab-select" class="w-full p-3 border border-amber-300 rounded-lg bg-white">
                    <option value="reservas">ü™ë Reservas</option>
                    <option value="pedidos">üõí Pedidos Online</option>
                    <option value="eventos">üéâ Eventos</option>
                    <option value="menu">üçΩÔ∏è Men√∫</option>
                    <option value="analytics">üìä Anal√≠ticas</option>
                    <option value="basement">ü™© S√≥tano</option>
                    <option value="clientes">üë• Clientes</option>
                    <option value="cuentas">üë§ Cuentas</option>
                    <option value="cover">üéüÔ∏è Covers / Staff</option>
                </select>
            </div>

            <div class="hidden sm:flex gap-4 mb-6 border-b border-amber-300 overflow-x-auto">
                <button id="tab-reservas" class="tab-btn active px-6 py-3 font-bold text-amber-800 border-b-2 border-amber-600 whitespace-nowrap" onclick="switchTab('reservas')">
                    ü™ë Reservas
                </button>
                <button id="tab-pedidos" class="tab-btn px-6 py-3 font-bold text-gray-500 border-b-2 border-transparent hover:text-amber-600 whitespace-nowrap" onclick="switchTab('pedidos')">
                    üõí Pedidos Online
                </button>
                <button id="tab-eventos" class="tab-btn px-6 py-3 font-bold text-gray-500 border-b-2 border-transparent hover:text-amber-600 whitespace-nowrap" onclick="switchTab('eventos')">
                    üéâ Eventos
                </button>
                <button id="tab-menu" class="tab-btn px-6 py-3 font-bold text-gray-500 border-b-2 border-transparent hover:text-amber-600 whitespace-nowrap" onclick="switchTab('menu')">
                    üçΩÔ∏è Men√∫
                </button>
                <button id="tab-analytics" class="tab-btn px-6 py-3 font-bold text-gray-500 border-b-2 border-transparent hover:text-amber-600 whitespace-nowrap" onclick="switchTab('analytics')">
                    üìä Anal√≠ticas
                </button>
                <button id="tab-basement" class="tab-btn px-6 py-3 font-bold text-gray-500 border-b-2 border-transparent hover:text-amber-600 whitespace-nowrap" onclick="switchTab('basement')">
                    ü™© S√≥tano
                </button>
                <button id="tab-clientes" class="tab-btn px-6 py-3 font-bold text-gray-500 border-b-2 border-transparent hover:text-amber-600 whitespace-nowrap" onclick="switchTab('clientes')">
                    üë• Clientes
                </button>
                <button id="tab-cuentas" class="tab-btn px-6 py-3 font-bold text-gray-500 border-b-2 border-transparent hover:text-amber-600 whitespace-nowrap" onclick="switchTab('cuentas')">
                    üë§ Cuentas
                </button>
                <button id="tab-cover" class="tab-btn px-6 py-3 font-bold text-gray-500 border-b-2 border-transparent hover:text-amber-600 whitespace-nowrap" onclick="switchTab('cover')">
                    üéüÔ∏è Covers / Staff
                </button>
            </div>

            <!-- Reservas Section -->
            <div id="section-reservas" class="flex flex-col">
                <div class="order-1 sm:order-1 flex flex-wrap justify-between items-center gap-3 mb-4 sm:mb-6">
                    <h2 class="text-2xl font-bold text-amber-800">Gesti√≥n de Reservas</h2>
                    <button type="button" onclick="showManualReservationModal()" class="bg-amber-600 hover:bg-amber-700 text-white px-4 py-2 rounded-lg transition-colors flex items-center gap-2">
                        <span>+</span> Agregar Reserva
                    </button>
                </div>
                <!-- Stats Reservas -->
                <div class="order-2 sm:order-2 grid grid-cols-2 md:grid-cols-4 gap-2 sm:gap-4 mb-4 sm:mb-8">
                    <div class="bg-white p-2 sm:p-4 rounded-lg shadow">
                        <p class="text-gray-500 text-xs sm:text-sm">Total Reservas</p>
                        <p id="stat-total" class="text-2xl sm:text-3xl font-bold text-amber-800">0</p>
                    </div>
                    <div class="bg-white p-2 sm:p-4 rounded-lg shadow">
                        <p class="text-gray-500 text-xs sm:text-sm">Pendientes</p>
                        <p id="stat-pendientes" class="text-2xl sm:text-3xl font-bold text-yellow-600">0</p>
                    </div>
                    <div class="bg-white p-2 sm:p-4 rounded-lg shadow">
                        <p class="text-gray-500 text-xs sm:text-sm">Confirmadas</p>
                        <p id="stat-confirmadas" class="text-2xl sm:text-3xl font-bold text-green-600">0</p>
                    </div>
                    <div class="bg-white p-2 sm:p-4 rounded-lg shadow">
                        <p class="text-gray-500 text-xs sm:text-sm">Canceladas</p>
                        <p id="stat-canceladas" class="text-2xl sm:text-3xl font-bold text-red-600">0</p>
                    </div>
                </div>
                
                <!-- Filters Reservas -->
                <div class="order-3 sm:order-3 grid grid-cols-2 sm:flex sm:flex-wrap gap-2 mb-4 sm:mb-6">
                    <button class="filter-btn active text-sm py-2" data-filter="all">Todas</button>
                    <button class="filter-btn text-sm py-2" data-filter="pendiente">Pendientes</button>
                    <button class="filter-btn text-sm py-2" data-filter="confirmada">Confirmadas</button>
                    <button class="filter-btn text-sm py-2" data-filter="cancelada">Canceladas</button>
                    <input type="date" id="filter-date" class="sm:ml-auto p-2 border border-amber-300 rounded-lg">
                </div>
                
                <!-- Reservations List -->
                <div id="reservations-list" class="order-4 sm:order-4">
                    <p class="text-gray-500 text-center py-4 sm:py-8">Cargando reservas...</p>
                </div>
            </div>

            <!-- Cuentas Section -->
            <div id="section-cuentas" class="hidden">
                <div class="flex flex-wrap justify-between items-center mb-6 gap-4">
                    <h2 class="text-2xl font-bold text-amber-800">üë§ Cuentas registradas</h2>
                    <div class="flex flex-wrap gap-2">
                        <button type="button" onclick="loadAuthUsersAdmin()" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-2 px-4 rounded-lg transition-colors">
                            Recargar
                        </button>
                    </div>
                </div>

                <div class="bg-white p-4 rounded-lg shadow mb-6">
                    <div class="flex flex-wrap gap-4 items-center">
                        <input type="text" id="auth-users-search" placeholder="Buscar por email o nombre..." 
                            class="flex-1 min-w-[220px] p-3 border border-amber-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500"
                            oninput="filterAuthUsersAdmin()">
                        <select id="auth-users-filter" class="p-3 border border-amber-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500" onchange="filterAuthUsersAdmin()">
                            <option value="all">Todas</option>
                            <option value="confirmed">Confirmadas</option>
                            <option value="unconfirmed">Sin confirmar</option>
                            <option value="banned">Baneadas</option>
                        </select>
                    </div>
                    <div id="auth-users-status" class="text-sm text-gray-500 mt-3"></div>
                </div>

                <div class="bg-white rounded-lg shadow overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-amber-100">
                                <tr>
                                    <th class="px-4 py-3 text-left text-amber-800 font-semibold">Usuario</th>
                                    <th class="px-4 py-3 text-left text-amber-800 font-semibold">Estado</th>
                                    <th class="px-4 py-3 text-left text-amber-800 font-semibold">Registro</th>
                                    <th class="px-4 py-3 text-left text-amber-800 font-semibold">√öltimo login</th>
                                    <th class="px-4 py-3 text-center text-amber-800 font-semibold">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="auth-users-list">
                                <tr>
                                    <td colspan="5" class="px-4 py-8 text-center text-gray-500">Cargando...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Pedidos Section -->
            <div id="section-pedidos" class="hidden">
                <!-- Stats Pedidos -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
                    <div class="bg-white p-2 sm:p-4 rounded-lg shadow">
                        <p class="text-gray-500 text-xs sm:text-sm">Total Pedidos</p>
                        <p id="stat-orders-total" class="text-2xl sm:text-3xl font-bold text-amber-800">0</p>
                    </div>
                    <div class="bg-white p-2 sm:p-4 rounded-lg shadow">
                        <p class="text-gray-500 text-xs sm:text-sm">Pendientes</p>
                        <p id="stat-orders-pendientes" class="text-2xl sm:text-3xl font-bold text-yellow-600">0</p>
                    </div>
                    <div class="bg-white p-2 sm:p-4 rounded-lg shadow">
                        <p class="text-gray-500 text-xs sm:text-sm">En Preparaci√≥n</p>
                        <p id="stat-orders-preparacion" class="text-2xl sm:text-3xl font-bold text-blue-600">0</p>
                    </div>
                    <div class="bg-white p-2 sm:p-4 rounded-lg shadow">
                        <p class="text-gray-500 text-xs sm:text-sm">Completados</p>
                        <p id="stat-orders-completados" class="text-2xl sm:text-3xl font-bold text-green-600">0</p>
                    </div>
                </div>
                
                <!-- Filters Pedidos -->
                <div class="flex flex-wrap gap-2 mb-6">
                    <button class="order-filter-btn active" data-filter="all">Todos</button>
                    <button class="order-filter-btn" data-filter="pendiente">Pendientes</button>
                    <button class="order-filter-btn" data-filter="preparacion">En Preparaci√≥n</button>
                    <button class="order-filter-btn" data-filter="completado">Completados</button>
                    <button class="order-filter-btn" data-filter="cancelado">Cancelados</button>
                </div>
                
                <!-- Orders List -->
                <div id="orders-list">
                    <p class="text-gray-500 text-center py-8">Cargando pedidos...</p>
                </div>
            </div>

            <!-- Eventos Section -->
            <div id="section-eventos" class="hidden">
                <!-- Header con bot√≥n agregar -->
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-amber-800">Gesti√≥n de Eventos</h2>
                    <button onclick="showEventModal()" class="bg-amber-600 hover:bg-amber-700 text-white px-4 py-2 rounded-lg transition-colors flex items-center gap-2">
                        <span>+</span> Nuevo Evento
                    </button>
                </div>
                
                <!-- Stats Eventos -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                    <div class="bg-white p-2 sm:p-4 rounded-lg shadow">
                        <p class="text-gray-500 text-xs sm:text-sm">Total Eventos</p>
                        <p id="stat-events-total" class="text-2xl sm:text-3xl font-bold text-amber-800">0</p>
                    </div>
                    <div class="bg-white p-2 sm:p-4 rounded-lg shadow">
                        <p class="text-gray-500 text-xs sm:text-sm">Activos</p>
                        <p id="stat-events-activos" class="text-2xl sm:text-3xl font-bold text-green-600">0</p>
                    </div>
                    <div class="bg-white p-2 sm:p-4 rounded-lg shadow">
                        <p class="text-gray-500 text-xs sm:text-sm">Pr√≥ximos 7 d√≠as</p>
                        <p id="stat-events-proximos" class="text-2xl sm:text-3xl font-bold text-blue-600">0</p>
                    </div>
                </div>
                
                <!-- Events List -->
                <div id="events-list">
                    <p class="text-gray-500 text-center py-8">Cargando eventos...</p>
                </div>
            </div>

            <!-- Men√∫ Section -->
            <div id="section-menu" class="hidden">
                <!-- Header con bot√≥n agregar -->
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-amber-800">Gesti√≥n del Men√∫</h2>
                    <button onclick="showMenuItemModal()" class="bg-amber-600 hover:bg-amber-700 text-white px-4 py-2 rounded-lg transition-colors flex items-center gap-2">
                        <span>+</span> Nuevo Plato/Bebida
                    </button>
                </div>
                
                <!-- Stats Men√∫ -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
                    <div class="bg-white p-2 sm:p-4 rounded-lg shadow">
                        <p class="text-gray-500 text-xs sm:text-sm">Total Items</p>
                        <p id="stat-menu-total" class="text-2xl sm:text-3xl font-bold text-amber-800">0</p>
                    </div>
                    <div class="bg-white p-2 sm:p-4 rounded-lg shadow">
                        <p class="text-gray-500 text-xs sm:text-sm">Platos</p>
                        <p id="stat-menu-platos" class="text-2xl sm:text-3xl font-bold text-orange-600">0</p>
                    </div>
                    <div class="bg-white p-2 sm:p-4 rounded-lg shadow">
                        <p class="text-gray-500 text-xs sm:text-sm">Bebidas</p>
                        <p id="stat-menu-bebidas" class="text-2xl sm:text-3xl font-bold text-blue-600">0</p>
                    </div>
                    <div class="bg-white p-2 sm:p-4 rounded-lg shadow">
                        <p class="text-gray-500 text-xs sm:text-sm">Activos</p>
                        <p id="stat-menu-activos" class="text-2xl sm:text-3xl font-bold text-green-600">0</p>
                    </div>
                </div>
                
                <!-- Filters Men√∫ -->
                <div class="flex flex-wrap gap-2 mb-6">
                    <button class="menu-filter-btn active" data-filter="all">Todos</button>
                    <button class="menu-filter-btn" data-filter="plato">Platos</button>
                    <button class="menu-filter-btn" data-filter="bebida">Bebidas</button>
                    <button class="menu-filter-btn" data-filter="oferta">Ofertas</button>
                </div>
                
                <!-- Menu Items List -->
                <div id="menu-items-list">
                    <p class="text-gray-500 text-center py-8">Cargando men√∫...</p>
                </div>
            </div>

            <!-- Analytics Section -->
            <div id="section-analytics" class="hidden">
                <div class="flex flex-wrap items-center justify-between gap-3 mb-6">
                    <h2 class="text-2xl font-bold text-amber-800">üìä Panel de Anal√≠ticas</h2>
                    <button id="btn-clear-analytics" onclick="clearAnalytics()" class="hidden bg-red-600 hover:bg-red-700 text-white font-bold px-4 py-2 rounded-lg transition-colors">
                        üóëÔ∏è Limpiar anal√≠ticas
                    </button>
                </div>
                
                <!-- Selector de per√≠odo -->
                <div class="flex flex-wrap gap-2 mb-6">
                    <button class="analytics-period-btn active" data-period="today">Hoy</button>
                    <button class="analytics-period-btn" data-period="week">Esta Semana</button>
                    <button class="analytics-period-btn" data-period="month">Este Mes</button>
                    <button class="analytics-period-btn" data-period="year">Este A√±o</button>
                </div>
                
                <!-- Stats principales -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
                    <div class="bg-white p-4 rounded-lg shadow">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-500 text-sm">Visitas Totales</p>
                                <p id="stat-visits" class="text-3xl font-bold text-amber-800">0</p>
                            </div>
                            <span class="text-4xl">üë•</span>
                        </div>
                        <p id="stat-visits-change" class="text-sm text-green-600 mt-2">+0% vs per√≠odo anterior</p>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-500 text-sm">Visitantes √önicos</p>
                                <p id="stat-unique-visitors" class="text-3xl font-bold text-blue-600">0</p>
                            </div>
                            <span class="text-4xl">üßë</span>
                        </div>
                        <p id="stat-unique-change" class="text-sm text-green-600 mt-2">+0% vs per√≠odo anterior</p>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-500 text-sm">P√°ginas Vistas</p>
                                <p id="stat-pageviews" class="text-3xl font-bold text-purple-600">0</p>
                            </div>
                            <span class="text-4xl">üìÑ</span>
                        </div>
                        <p id="stat-pageviews-change" class="text-sm text-green-600 mt-2">+0% vs per√≠odo anterior</p>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-500 text-sm">Tiempo Promedio</p>
                                <p id="stat-avg-time" class="text-3xl font-bold text-green-600">0:00</p>
                            </div>
                            <span class="text-4xl">‚è±Ô∏è</span>
                        </div>
                        <p class="text-sm text-gray-500 mt-2">minutos en el sitio</p>
                    </div>
                </div>
                
                <!-- Segunda fila de stats -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
                    <div class="bg-white p-4 rounded-lg shadow">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-500 text-sm">Clicks Totales</p>
                                <p id="stat-clicks" class="text-3xl font-bold text-orange-600">0</p>
                            </div>
                            <span class="text-4xl">üëÜ</span>
                        </div>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-500 text-sm">Tasa de Rebote</p>
                                <p id="stat-bounce-rate" class="text-3xl font-bold text-red-600">0%</p>
                            </div>
                            <span class="text-4xl">‚Ü©Ô∏è</span>
                        </div>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-500 text-sm">Conversiones</p>
                                <p id="stat-conversions" class="text-3xl font-bold text-emerald-600">0</p>
                            </div>
                            <span class="text-4xl">üéØ</span>
                        </div>
                        <p class="text-sm text-gray-500 mt-2">pedidos + reservas</p>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-500 text-sm">Tasa Conversi√≥n</p>
                                <p id="stat-conversion-rate" class="text-3xl font-bold text-teal-600">0%</p>
                            </div>
                            <span class="text-4xl">üìà</span>
                        </div>
                    </div>
                </div>
                
                <!-- Gr√°ficos y tablas -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                    <!-- Visitas por d√≠a -->
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="text-lg font-bold text-amber-800 mb-4">üìÖ Visitas por D√≠a de la Semana</h3>
                        <div id="chart-days" class="space-y-2">
                            <div class="flex items-center gap-2">
                                <span class="w-20 text-sm">Lunes</span>
                                <div class="flex-1 bg-gray-200 rounded-full h-6">
                                    <div id="bar-lunes" class="bg-amber-500 h-6 rounded-full" style="width: 0%"></div>
                                </div>
                                <span id="count-lunes" class="w-12 text-sm text-right">0</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="w-20 text-sm">Martes</span>
                                <div class="flex-1 bg-gray-200 rounded-full h-6">
                                    <div id="bar-martes" class="bg-amber-500 h-6 rounded-full" style="width: 0%"></div>
                                </div>
                                <span id="count-martes" class="w-12 text-sm text-right">0</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="w-20 text-sm">Mi√©rcoles</span>
                                <div class="flex-1 bg-gray-200 rounded-full h-6">
                                    <div id="bar-miercoles" class="bg-amber-500 h-6 rounded-full" style="width: 0%"></div>
                                </div>
                                <span id="count-miercoles" class="w-12 text-sm text-right">0</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="w-20 text-sm">Jueves</span>
                                <div class="flex-1 bg-gray-200 rounded-full h-6">
                                    <div id="bar-jueves" class="bg-amber-500 h-6 rounded-full" style="width: 0%"></div>
                                </div>
                                <span id="count-jueves" class="w-12 text-sm text-right">0</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="w-20 text-sm">Viernes</span>
                                <div class="flex-1 bg-gray-200 rounded-full h-6">
                                    <div id="bar-viernes" class="bg-amber-500 h-6 rounded-full" style="width: 0%"></div>
                                </div>
                                <span id="count-viernes" class="w-12 text-sm text-right">0</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="w-20 text-sm">S√°bado</span>
                                <div class="flex-1 bg-gray-200 rounded-full h-6">
                                    <div id="bar-sabado" class="bg-amber-600 h-6 rounded-full" style="width: 0%"></div>
                                </div>
                                <span id="count-sabado" class="w-12 text-sm text-right">0</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="w-20 text-sm">Domingo</span>
                                <div class="flex-1 bg-gray-200 rounded-full h-6">
                                    <div id="bar-domingo" class="bg-amber-600 h-6 rounded-full" style="width: 0%"></div>
                                </div>
                                <span id="count-domingo" class="w-12 text-sm text-right">0</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- P√°ginas m√°s visitadas -->
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="text-lg font-bold text-amber-800 mb-4">üî• P√°ginas M√°s Visitadas</h3>
                        <div id="top-pages" class="space-y-3">
                            <p class="text-gray-500 text-center py-4">Cargando...</p>
                        </div>
                    </div>
                </div>
                
                <!-- M√°s estad√≠sticas -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                    <!-- Dispositivos -->
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="text-lg font-bold text-amber-800 mb-4">üì± Dispositivos</h3>
                        <div id="devices-stats" class="space-y-3">
                            <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                <div class="flex items-center gap-3">
                                    <span class="text-2xl">üì±</span>
                                    <span>M√≥vil</span>
                                </div>
                                <div class="text-right">
                                    <span id="device-mobile" class="font-bold text-amber-800">0%</span>
                                    <span id="device-mobile-count" class="text-sm text-gray-500 ml-2">(0)</span>
                                </div>
                            </div>
                            <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                <div class="flex items-center gap-3">
                                    <span class="text-2xl">üíª</span>
                                    <span>Desktop</span>
                                </div>
                                <div class="text-right">
                                    <span id="device-desktop" class="font-bold text-amber-800">0%</span>
                                    <span id="device-desktop-count" class="text-sm text-gray-500 ml-2">(0)</span>
                                </div>
                            </div>
                            <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                <div class="flex items-center gap-3">
                                    <span class="text-2xl">üìü</span>
                                    <span>Tablet</span>
                                </div>
                                <div class="text-right">
                                    <span id="device-tablet" class="font-bold text-amber-800">0%</span>
                                    <span id="device-tablet-count" class="text-sm text-gray-500 ml-2">(0)</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Fuentes de tr√°fico -->
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="text-lg font-bold text-amber-800 mb-4">üåê Fuentes de Tr√°fico</h3>
                        <div id="traffic-sources" class="space-y-3">
                            <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                <div class="flex items-center gap-3">
                                    <span class="text-2xl">üîç</span>
                                    <span>B√∫squeda Org√°nica</span>
                                </div>
                                <span id="source-organic" class="font-bold text-amber-800">0%</span>
                            </div>
                            <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                <div class="flex items-center gap-3">
                                    <span class="text-2xl">üîó</span>
                                    <span>Directo</span>
                                </div>
                                <span id="source-direct" class="font-bold text-amber-800">0%</span>
                            </div>
                            <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                <div class="flex items-center gap-3">
                                    <span class="text-2xl">üì±</span>
                                    <span>Redes Sociales</span>
                                </div>
                                <span id="source-social" class="font-bold text-amber-800">0%</span>
                            </div>
                            <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                <div class="flex items-center gap-3">
                                    <span class="text-2xl">üìß</span>
                                    <span>Referidos</span>
                                </div>
                                <span id="source-referral" class="font-bold text-amber-800">0%</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Actividad reciente -->
                <div class="bg-white p-6 rounded-lg shadow">
                    <h3 class="text-lg font-bold text-amber-800 mb-4">‚ö° Actividad Reciente</h3>
                    <div id="recent-activity" class="space-y-2 max-h-96 overflow-y-auto">
                        <p class="text-gray-500 text-center py-4">Cargando actividad...</p>
                    </div>
                </div>
            </div>

            <!-- Basement Analytics Section -->
            <div id="section-basement" class="hidden">
                <div class="flex flex-wrap items-center justify-between gap-3 mb-6">
                    <h2 class="text-2xl font-bold text-amber-800">ü™© Anal√≠ticas S√≥tano (Cover)</h2>
                    <button onclick="loadBasementAnalytics()" class="bg-amber-600 hover:bg-amber-700 text-white font-bold px-4 py-2 rounded-lg transition-colors">
                        üîÑ Actualizar
                    </button>
                </div>

                <div class="bg-white p-4 rounded-lg shadow mb-6">
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                        <div>
                            <label class="block text-sm font-bold text-amber-800 mb-1">Rango (d√≠as)</label>
                            <input id="basement-days" type="number" min="1" max="365" value="30" class="w-full p-2 border border-amber-300 rounded-lg">
                        </div>
                        <div>
                            <label class="block text-sm font-bold text-amber-800 mb-1">Top clientes</label>
                            <input id="basement-top" type="number" min="5" max="200" value="30" class="w-full p-2 border border-amber-300 rounded-lg">
                        </div>
                        <div class="col-span-2 md:col-span-2 flex items-end">
                            <div id="basement-status" class="text-sm text-gray-600"></div>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-white p-4 rounded-lg shadow">
                        <h3 class="text-lg font-bold text-amber-800 mb-4">Covers vendidos por d√≠a</h3>
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-amber-100">
                                    <tr>
                                        <th class="px-3 py-2 text-left text-amber-800 font-semibold">D√≠a</th>
                                        <th class="px-3 py-2 text-left text-amber-800 font-semibold">Covers</th>
                                        <th class="px-3 py-2 text-left text-amber-800 font-semibold">Ingresos (PLN)</th>
                                    </tr>
                                </thead>
                                <tbody id="basement-daily">
                                    <tr><td colspan="3" class="px-3 py-6 text-center text-gray-500">Cargando...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="bg-white p-4 rounded-lg shadow">
                        <h3 class="text-lg font-bold text-amber-800 mb-4">Clientes m√°s frecuentes (covers)</h3>
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-amber-100">
                                    <tr>
                                        <th class="px-3 py-2 text-left text-amber-800 font-semibold">Email</th>
                                        <th class="px-3 py-2 text-left text-amber-800 font-semibold">Covers</th>
                                        <th class="px-3 py-2 text-left text-amber-800 font-semibold">Reservas</th>
                                    </tr>
                                </thead>
                                <tbody id="basement-customers">
                                    <tr><td colspan="3" class="px-3 py-6 text-center text-gray-500">Cargando...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Clientes Section -->
            <div id="section-clientes" class="hidden">
                <div class="flex flex-wrap justify-between items-center mb-6 gap-4">
                    <h2 class="text-2xl font-bold text-amber-800">üë• Gesti√≥n de Clientes</h2>
                    <div class="flex flex-wrap gap-2">
                        <button onclick="showClientModal()" class="bg-amber-600 hover:bg-amber-700 text-white px-4 py-2 rounded-lg transition-colors flex items-center gap-2">
                            <span>+</span> Agregar Cliente
                        </button>
                        <button onclick="exportClientsExcel()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition-colors flex items-center gap-2">
                            üìä Exportar Excel
                        </button>
                        <button onclick="exportClientsPDF()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg transition-colors flex items-center gap-2">
                            üìÑ Exportar PDF
                        </button>
                        <button onclick="showEmailMarketingModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors flex items-center gap-2">
                            ‚úâÔ∏è Email Marketing
                        </button>
                        <button onclick="openZohoInbox()" class="bg-slate-700 hover:bg-slate-800 text-white px-4 py-2 rounded-lg transition-colors flex items-center gap-2">
                            üì• Abrir Zoho Mail
                        </button>
                    </div>
                </div>
                
                <!-- Stats Clientes -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
                    <div class="bg-white p-2 sm:p-4 rounded-lg shadow">
                        <p class="text-gray-500 text-xs sm:text-sm">Total Clientes</p>
                        <p id="stat-clientes-total" class="text-2xl sm:text-3xl font-bold text-amber-800">0</p>
                    </div>
                    <div class="bg-white p-2 sm:p-4 rounded-lg shadow">
                        <p class="text-gray-500 text-xs sm:text-sm">Nuevos (Este Mes)</p>
                        <p id="stat-clientes-nuevos" class="text-2xl sm:text-3xl font-bold text-green-600">0</p>
                    </div>
                    <div class="bg-white p-2 sm:p-4 rounded-lg shadow">
                        <p class="text-gray-500 text-xs sm:text-sm">Con Reservas</p>
                        <p id="stat-clientes-reservas" class="text-2xl sm:text-3xl font-bold text-blue-600">0</p>
                    </div>
                    <div class="bg-white p-2 sm:p-4 rounded-lg shadow">
                        <p class="text-gray-500 text-xs sm:text-sm">Con Pedidos</p>
                        <p id="stat-clientes-pedidos" class="text-2xl sm:text-3xl font-bold text-purple-600">0</p>
                    </div>
                </div>
                
                <!-- B√∫squeda y filtros -->
                <div class="bg-white p-4 rounded-lg shadow mb-6">
                    <div class="flex flex-wrap gap-4">
                        <input type="text" id="client-search" placeholder="Buscar por nombre, email o tel√©fono..." 
                            class="flex-1 min-w-[200px] p-3 border border-amber-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500"
                            oninput="filterClients()">
                        <select id="client-filter" class="p-3 border border-amber-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500" onchange="filterClients()">
                            <option value="all">Todos los clientes</option>
                            <option value="with-reservations">Con reservas</option>
                            <option value="with-orders">Con pedidos</option>
                            <option value="subscribed">Suscritos a newsletter</option>
                        </select>
                    </div>
                </div>
                
                <!-- Lista de Clientes -->
                <div class="bg-white rounded-lg shadow overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-amber-100">
                                <tr>
                                    <th class="px-4 py-3 text-left text-amber-800 font-semibold">Cliente</th>
                                    <th class="px-4 py-3 text-left text-amber-800 font-semibold">Contacto</th>
                                    <th class="px-4 py-3 text-left text-amber-800 font-semibold">Reservas</th>
                                    <th class="px-4 py-3 text-left text-amber-800 font-semibold">Pedidos</th>
                                    <th class="px-4 py-3 text-left text-amber-800 font-semibold">Newsletter</th>
                                    <th class="px-4 py-3 text-left text-amber-800 font-semibold">Registro</th>
                                    <th class="px-4 py-3 text-center text-amber-800 font-semibold">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="clients-list">
                                <tr>
                                    <td colspan="7" class="px-4 py-8 text-center text-gray-500">Cargando clientes...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Cover/Staff Section -->
            <div id="section-cover" class="hidden">
                <div class="flex flex-wrap justify-between items-center mb-6 gap-4">
                    <h2 class="text-2xl font-bold text-amber-800">üéüÔ∏è Covers / Staff</h2>
                    <a href="staff.html" target="_blank" rel="noopener noreferrer" class="bg-slate-700 hover:bg-slate-800 text-white px-4 py-2 rounded-lg transition-colors">
                        Abrir p√°gina Staff
                    </a>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="text-lg font-bold text-amber-800 mb-4">Configuraci√≥n Cover (DJ + Precio)</h3>
                        <form id="cover-config-form" class="space-y-4">
                            <div>
                                <label class="block text-amber-700 font-medium mb-1">DJ del finde</label>
                                <input type="text" id="cover-dj" class="w-full p-3 border border-amber-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500" placeholder="Ej: Dj Micke">
                            </div>
                            <div>
                                <label class="block text-amber-700 font-medium mb-1">Precio (PLN)</label>
                                <input type="number" id="cover-price" min="1" step="1" class="w-full p-3 border border-amber-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500" placeholder="30">
                            </div>
                            <div class="flex items-center gap-2">
                                <input type="checkbox" id="cover-active" class="w-5 h-5 text-amber-600 border-amber-300 rounded focus:ring-amber-500" checked>
                                <label for="cover-active" class="text-amber-700">Cover activo</label>
                            </div>
                            <div class="flex gap-3">
                                <button type="button" onclick="loadCoverConfigAdmin()" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-3 px-4 rounded-lg transition-colors">Recargar</button>
                                <button type="submit" class="bg-amber-600 hover:bg-amber-700 text-white font-bold py-3 px-4 rounded-lg transition-colors">Guardar</button>
                            </div>
                            <div id="cover-config-status" class="text-sm text-gray-500"></div>
                        </form>
                    </div>

                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="text-lg font-bold text-amber-800 mb-4">Usuarios Staff (login PIN)</h3>
                        <form id="staff-create-form" class="grid md:grid-cols-3 gap-3 mb-4">
                            <input id="staff-username" type="text" placeholder="usuario" class="p-3 border border-amber-300 rounded-lg" required>
                            <input id="staff-pin" type="password" placeholder="PIN" class="p-3 border border-amber-300 rounded-lg" required>
                            <button class="bg-amber-600 hover:bg-amber-700 text-white font-bold py-3 px-4 rounded-lg">Crear</button>
                        </form>
                        <div class="flex gap-3 mb-4">
                            <button type="button" onclick="loadStaffUsers()" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-2 px-4 rounded-lg transition-colors">Recargar lista</button>
                        </div>
                        <div id="staff-users-status" class="text-sm text-gray-500 mb-3"></div>
                        <div id="staff-users-list" class="space-y-2">
                            <p class="text-gray-500">Cargando...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para agregar/editar cliente -->
    <div id="client-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-lg w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 id="client-modal-title" class="text-xl font-bold text-amber-800">Nuevo Cliente</h3>
                    <button onclick="closeClientModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
                </div>
                
                <form id="client-form" class="space-y-4">
                    <input type="hidden" id="client-id">
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-amber-700 font-medium mb-1">Nombre *</label>
                            <input type="text" id="client-nombre" required
                                class="w-full p-3 border border-amber-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500"
                                placeholder="Nombre completo">
                        </div>
                        <div>
                            <label class="block text-amber-700 font-medium mb-1">Tel√©fono</label>
                            <input type="tel" id="client-telefono"
                                class="w-full p-3 border border-amber-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500"
                                placeholder="+48 123 456 789">
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-amber-700 font-medium mb-1">Email *</label>
                        <input type="email" id="client-email" required
                            class="w-full p-3 border border-amber-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500"
                            placeholder="cliente@email.com">
                    </div>
                    
                    <div>
                        <label class="block text-amber-700 font-medium mb-1">Direcci√≥n</label>
                        <input type="text" id="client-direccion"
                            class="w-full p-3 border border-amber-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500"
                            placeholder="Direcci√≥n completa">
                    </div>
                    
                    <div>
                        <label class="block text-amber-700 font-medium mb-1">Notas</label>
                        <textarea id="client-notas" rows="2"
                            class="w-full p-3 border border-amber-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500"
                            placeholder="Preferencias, alergias, notas especiales..."></textarea>
                    </div>
                    
                    <div class="flex items-center gap-2">
                        <input type="checkbox" id="client-newsletter" checked
                            class="w-5 h-5 text-amber-600 border-amber-300 rounded focus:ring-amber-500">
                        <label for="client-newsletter" class="text-amber-700">Suscrito a newsletter y promociones</label>
                    </div>
                    
                    <div class="flex gap-3 pt-4">
                        <button type="button" onclick="closeClientModal()" 
                            class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-3 rounded-lg transition-colors">
                            Cancelar
                        </button>
                        <button type="submit" 
                            class="flex-1 bg-amber-600 hover:bg-amber-700 text-white font-bold py-3 rounded-lg transition-colors">
                            Guardar Cliente
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal para Email Marketing -->
    <div id="email-marketing-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-amber-800">‚úâÔ∏è Enviar Email Marketing</h3>
                    <button onclick="closeEmailMarketingModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
                </div>
                
                <form id="email-marketing-form" class="space-y-4">
                    <div class="bg-amber-50 p-4 rounded-lg mb-4">
                        <p class="text-amber-800 font-medium">üìß Destinatarios: <span id="email-recipients-count">0</span> clientes suscritos</p>
                        <p class="text-sm text-amber-600 mt-1">Solo se enviar√° a clientes que aceptaron recibir comunicaciones.</p>
                    </div>
                    
                    <div>
                        <label class="block text-amber-700 font-medium mb-1">Tipo de Campa√±a *</label>
                        <select id="email-campaign-type" required
                            class="w-full p-3 border border-amber-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500"
                            onchange="updateEmailTemplate()">
                            <option value="">Selecciona un tipo...</option>
                            <option value="nuevo-plato">üçΩÔ∏è Nuevo Plato</option>
                            <option value="nuevo-evento">üéâ Nuevo Evento</option>
                            <option value="promocion">üè∑Ô∏è Promoci√≥n Especial</option>
                            <option value="newsletter">üì∞ Newsletter General</option>
                            <option value="custom">‚úèÔ∏è Mensaje Personalizado</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-amber-700 font-medium mb-1">Asunto del Email *</label>
                        <input type="text" id="email-subject" required
                            class="w-full p-3 border border-amber-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500"
                            placeholder="Ej: ¬°Nuevo plato en Macondo Bar Latino!">
                    </div>
                    
                    <div>
                        <label class="block text-amber-700 font-medium mb-1">Contenido del Email *</label>
                        <textarea id="email-content" rows="8" required
                            class="w-full p-3 border border-amber-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500"
                            placeholder="Escribe el contenido de tu email..."></textarea>
                    </div>
                    
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <p class="text-sm text-gray-600 mb-2">üìù <strong>Vista previa:</strong></p>
                        <div id="email-preview" class="bg-white p-4 rounded border text-sm">
                            <p class="text-gray-400 italic">Selecciona un tipo de campa√±a para ver la vista previa...</p>
                        </div>
                    </div>
                    
                    <div class="flex gap-3 pt-4">
                        <button type="button" onclick="closeEmailMarketingModal()" 
                            class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-3 rounded-lg transition-colors">
                            Cancelar
                        </button>
                        <button type="button" onclick="sendTestEmail()"
                            class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-lg transition-colors">
                            üìß Enviar Prueba
                        </button>
                        <button type="submit" 
                            class="flex-1 bg-amber-600 hover:bg-amber-700 text-white font-bold py-3 rounded-lg transition-colors">
                            üöÄ Enviar a Todos
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal para crear/editar item del men√∫ -->
    <div id="menu-item-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-lg w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 id="menu-modal-title" class="text-xl font-bold text-amber-800">Nuevo Item</h3>
                    <button onclick="closeMenuItemModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
                </div>
                
                <form id="menu-item-form" class="space-y-4">
                    <input type="hidden" id="menu-item-id">
                    
                    <div>
                        <label class="block text-amber-700 font-medium mb-1">Nombre *</label>
                        <input type="text" id="menu-item-nombre" required
                            class="w-full p-3 border border-amber-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500"
                            placeholder="Ej: Bandeja Paisa">
                    </div>
                    
                    <div>
                        <label class="block text-amber-700 font-medium mb-1">Descripci√≥n</label>
                        <textarea id="menu-item-descripcion" rows="2"
                            class="w-full p-3 border border-amber-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500"
                            placeholder="Describe el plato o bebida..."></textarea>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-amber-700 font-medium mb-1">Precio (PLN) *</label>
                            <input type="number" step="0.01" id="menu-item-precio" required
                                class="w-full p-3 border border-amber-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500"
                                placeholder="35.00">
                        </div>
                        <div>
                            <label class="block text-amber-700 font-medium mb-1">Categor√≠a *</label>
                            <select id="menu-item-categoria" required
                                class="w-full p-3 border border-amber-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500">
                                <option value="plato">Plato</option>
                                <option value="bebida">Bebida</option>
                                <option value="oferta">Oferta</option>
                            </select>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-amber-700 font-medium mb-1">Imagen</label>
                        <div class="space-y-2">
                            <input type="file" id="menu-item-file" accept="image/*"
                                class="w-full p-2 border border-amber-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500 text-sm"
                                onchange="previewMenuImage(this)">
                            <div id="menu-image-preview" class="hidden">
                                <img id="menu-preview-img" src="" alt="Preview" class="w-32 h-24 object-cover rounded-lg">
                            </div>
                            <p class="text-xs text-gray-500">O ingresa una URL:</p>
                            <input type="text" id="menu-item-imagen"
                                class="w-full p-2 border border-amber-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500 text-sm"
                                placeholder="https://ejemplo.com/imagen.jpg">
                        </div>
                    </div>
                    
                    <div class="flex items-center gap-2">
                        <input type="checkbox" id="menu-item-activo" checked class="w-5 h-5 text-amber-600">
                        <label for="menu-item-activo" class="text-amber-700 font-medium">Item activo (visible en la web)</label>
                    </div>
                    
                    <div class="flex gap-3 pt-4">
                        <button type="button" onclick="closeMenuItemModal()" 
                            class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-3 rounded-lg transition-colors">
                            Cancelar
                        </button>
                        <button type="submit" 
                            class="flex-1 bg-amber-600 hover:bg-amber-700 text-white font-bold py-3 rounded-lg transition-colors">
                            Guardar
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal para crear/editar evento -->
    <div id="event-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-lg w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 id="modal-title" class="text-xl font-bold text-amber-800">Nuevo Evento</h3>
                    <button onclick="closeEventModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
                </div>
                
                <form id="event-form" class="space-y-4">
                    <input type="hidden" id="event-id">
                    
                    <div>
                        <label class="block text-amber-700 font-medium mb-1">T√≠tulo *</label>
                        <input type="text" id="event-titulo" required
                            class="w-full p-3 border border-amber-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500"
                            placeholder="Ej: Noche de Salsa">
                    </div>
                    
                    <div>
                        <label class="block text-amber-700 font-medium mb-1">Descripci√≥n</label>
                        <textarea id="event-descripcion" rows="3"
                            class="w-full p-3 border border-amber-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500"
                            placeholder="Describe el evento..."></textarea>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-amber-700 font-medium mb-1">Fecha *</label>
                            <input type="date" id="event-fecha" required
                                class="w-full p-3 border border-amber-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500">
                        </div>
                        <div>
                            <label class="block text-amber-700 font-medium mb-1">Hora</label>
                            <input type="time" id="event-hora"
                                class="w-full p-3 border border-amber-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500">
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-amber-700 font-medium mb-1">Imagen</label>
                        <div class="space-y-2">
                            <input type="file" id="event-file" accept="image/*"
                                class="w-full p-2 border border-amber-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500 text-sm"
                                onchange="previewEventImage(this)">
                            <div id="event-image-preview" class="hidden">
                                <img id="event-preview-img" src="" alt="Preview" class="w-32 h-24 object-cover rounded-lg">
                            </div>
                            <p class="text-xs text-gray-500">O ingresa una URL:</p>
                            <input type="text" id="event-imagen"
                                class="w-full p-2 border border-amber-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500 text-sm"
                                placeholder="https://ejemplo.com/imagen.jpg">
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-amber-700 font-medium mb-1">Ubicaci√≥n</label>
                        <input type="text" id="event-ubicacion" value="Macondo Bar Latino"
                            class="w-full p-3 border border-amber-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500">
                    </div>
                    
                    <div>
                        <label class="block text-amber-700 font-medium mb-1">Precio</label>
                        <input type="text" id="event-precio"
                            class="w-full p-3 border border-amber-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500"
                            placeholder="Ej: Gratis, 20 PLN, etc.">
                    </div>
                    
                    <div class="flex items-center gap-2">
                        <input type="checkbox" id="event-activo" checked class="w-5 h-5 text-amber-600">
                        <label for="event-activo" class="text-amber-700 font-medium">Evento activo (visible en la web)</label>
                    </div>
                    
                    <div class="flex gap-3 pt-4">
                        <button type="button" onclick="closeEventModal()" 
                            class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-3 rounded-lg transition-colors">
                            Cancelar
                        </button>
                        <button type="submit" 
                            class="flex-1 bg-amber-600 hover:bg-amber-700 text-white font-bold py-3 rounded-lg transition-colors">
                            Guardar Evento
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Configuraci√≥n de Supabase
        const SUPABASE_URL = 'https://imqcifvmklkccwagpkee.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImltcWNpZnZta2xrY2N3YWdwa2VlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkxMjMzNDIsImV4cCI6MjA4NDY5OTM0Mn0.fP4S0VfaC823LKUvh6HcybS_ze9uWWrBKgC4SsQBiRU';
        
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        let currentFilter = 'all';
        let currentOrderFilter = 'all';
        let currentMenuFilter = 'all';
        let reservations = [];
        let orders = [];
        let events = [];
        let menuItems = [];
        
        // Verificar sesi√≥n al cargar
        document.addEventListener('DOMContentLoaded', async () => {
            const { data: { session } } = await supabaseClient.auth.getSession();
            
            if (session) {
                // Verificar si es admin
                const isAdmin = await checkIfAdmin(session.user.email);
                if (isAdmin) {
                    showAdminPanel(session.user.email);
                } else {
                    showError('No tienes permisos de administrador');
                    await supabaseClient.auth.signOut();
                }
            }
            
            feather.replace();
        });
        
        // Verificar si el usuario es admin
        async function checkIfAdmin(email) {
            const { data, error } = await supabaseClient
                .from('admins')
                .select('email')
                .eq('email', email)
                .single();
            
            return data !== null;
        }
        
        // Login
        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const email = document.getElementById('admin-email').value;
            const password = document.getElementById('admin-password').value;
            
            // Primero verificar si es admin
            const isAdmin = await checkIfAdmin(email);
            if (!isAdmin) {
                showError('No tienes permisos de administrador');
                return;
            }
            
            // Intentar login con Supabase Auth
            const { data, error } = await supabaseClient.auth.signInWithPassword({
                email,
                password
            });
            
            if (error) {
                showError(error.message);
                return;
            }
            
            showAdminPanel(email);
        });
        
        // Mostrar error
        function showError(message) {
            const errorDiv = document.getElementById('login-error');
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
        }
        
        // Mostrar panel de admin
        function showAdminPanel(email) {
            document.getElementById('login-section').classList.add('hidden');
            document.getElementById('admin-panel').classList.remove('hidden');
            document.getElementById('user-info').classList.remove('hidden');
            document.getElementById('user-email').textContent = email;

            updateOwnerControls(email);
            
            loadReservations();
            loadOrders();
            loadEvents();
            loadMenuItems();
            setupFilters();
            setupOrderFilters();
            setupMenuFilters();
        }
        
        // Cambiar entre pesta√±as
        function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active', 'text-amber-800', 'border-amber-600');
                btn.classList.add('text-gray-500', 'border-transparent');
            });
            
            const activeTab = document.getElementById('tab-' + tab);
            if (activeTab) {
                activeTab.classList.add('active', 'text-amber-800', 'border-amber-600');
                activeTab.classList.remove('text-gray-500', 'border-transparent');
            }
            
            document.getElementById('section-reservas').classList.add('hidden');
            document.getElementById('section-pedidos').classList.add('hidden');
            document.getElementById('section-eventos').classList.add('hidden');
            document.getElementById('section-menu').classList.add('hidden');
            document.getElementById('section-analytics').classList.add('hidden');
            document.getElementById('section-basement').classList.add('hidden');
            document.getElementById('section-clientes').classList.add('hidden');
            document.getElementById('section-cuentas').classList.add('hidden');
            document.getElementById('section-cover').classList.add('hidden');
            document.getElementById('section-' + tab).classList.remove('hidden');
            
            if (tab === 'analytics') {
                updateOwnerControls(document.getElementById('user-email')?.textContent || '');
                loadAnalytics();
            }
            if (tab === 'basement') {
                loadBasementAnalytics();
            }
            if (tab === 'clientes') {
                loadClients();
            }
            if (tab === 'cuentas') {
                loadAuthUsersAdmin();
            }
            if (tab === 'cover') {
                loadCoverConfigAdmin();
                loadStaffUsers();
            }

            const mobileSelect = document.getElementById('mobile-tab-select');
            if (mobileSelect) {
                mobileSelect.value = tab;
            }
        }

        async function sendReservationReactivatedEmail(reservation) {
            const email = String(reservation?.email || '').trim();
            if (!email) return;

            const nombre = String(reservation?.nombre || '').trim() || 'Cliente';
            const fecha = formatDate(reservation?.fecha);
            const hora = String(reservation?.hora_entrada || '').trim() || '‚Äî';
            const personas = String(reservation?.personas ?? '').trim() || '‚Äî';
            const mesa = String(reservation?.mesa || '').trim();
            const foto = String(reservation?.mesa_foto_url || '').trim();

            const html = `
                <div style="font-family:Arial,sans-serif;line-height:1.5;background:#fff;padding:20px">
                  <div style="max-width:600px;margin:0 auto;border:1px solid #eee;border-radius:12px;overflow:hidden">
                    <div style="background:#fef3c7;padding:16px 20px">
                      <div style="display:flex;align-items:center;gap:12px">
                        <img src="https://macondo.pl/logoamarillo.png" alt="Macondo" style="height:40px;width:auto" />
                        <div style="font-weight:800;color:#92400e;font-size:18px">Macondo</div>
                      </div>
                    </div>
                    <div style="padding:20px">
                      <h2 style="margin:0 0 10px 0;color:#92400e">Tu reserva ha sido reactivada</h2>
                      <p style="margin:0 0 14px 0">Hola ${escapeHtml(nombre)},</p>
                      <p style="margin:0 0 14px 0">Tu reserva vuelve a estar activa y en estado <b>pendiente</b>. Te avisaremos cuando est√© confirmada.</p>
                      <div style="background:#fff7ed;border:1px solid #fed7aa;border-radius:10px;padding:14px">
                        <div><b>Fecha:</b> ${escapeHtml(fecha)}</div>
                        <div><b>Hora:</b> ${escapeHtml(hora)}</div>
                        <div><b>Personas:</b> ${escapeHtml(personas)}</div>
                        <div><b>Mesa:</b> ${escapeHtml(mesa || 'A√∫n no asignada')}</div>
                        ${foto ? `<div style=\"margin-top:10px\"><a href=\"${foto}\" target=\"_blank\" rel=\"noopener noreferrer\">Ver foto de mesa</a></div>` : ''}
                      </div>
                      <p style="margin:14px 0 0 0;color:#6b7280;font-size:12px">Si no solicitaste este cambio, cont√°ctanos.</p>
                    </div>
                  </div>
                </div>
            `;

            const subject = 'Reserva reactivada - Macondo';

            const resp = await fetch('/.netlify/functions/send-email', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + (await getAdminAccessToken())
                },
                body: JSON.stringify({
                    mode: 'single',
                    toEmail: email,
                    toName: nombre,
                    subject,
                    content: 'Tu reserva ha sido reactivada.',
                    html
                })
            });

            const data = await resp.json().catch(() => ({}));
            if (!resp.ok) {
                throw new Error(data.error || resp.statusText);
            }
        }

        const mobileTabSelect = document.getElementById('mobile-tab-select');
        if (mobileTabSelect) {
            mobileTabSelect.addEventListener('change', (e) => {
                switchTab(e.target.value);
            });
        }

        let authUsersCache = [];

        function safeDate(d) {
            if (!d) return '‚Äî';
            const dd = new Date(d);
            if (Number.isNaN(dd.getTime())) return String(d);
            return dd.toLocaleString('es-ES');
        }

        function renderAuthUsersAdmin(list) {
            const tbody = document.getElementById('auth-users-list');
            if (!tbody) return;

            if (!Array.isArray(list) || list.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="px-4 py-8 text-center text-gray-500">No hay cuentas para mostrar</td></tr>';
                return;
            }

            tbody.innerHTML = list.map(u => {
                const email = String(u.email || '');
                const name = String(u.user_metadata?.name || '');
                const confirmed = !!(u.email_confirmed_at || u.confirmed_at);
                const banned = !!u.banned_until;
                const isAdmin = !!u.is_admin;

                const st = banned
                    ? { text: 'Baneada', cls: 'text-red-700 bg-red-100' }
                    : confirmed
                        ? { text: 'Confirmada', cls: 'text-green-700 bg-green-100' }
                        : { text: 'Sin confirmar', cls: 'text-yellow-700 bg-yellow-100' };

                const adminBadge = isAdmin
                    ? `<span class="px-2 py-1 rounded-full text-xs font-bold text-purple-700 bg-purple-100">Admin</span>`
                    : '';

                const actionBtn = isAdmin
                    ? `<span class="text-xs text-gray-500">Protegida</span>`
                    : (banned
                        ? `<button class="bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded-lg" onclick="unbanAuthUserAdmin('${u.id}')">Unban</button>`
                        : `<button class="bg-red-600 hover:bg-red-700 text-white px-3 py-2 rounded-lg" onclick="banAuthUserAdmin('${u.id}')">Ban</button>`);

                return `
                    <tr class="border-t">
                        <td class="px-4 py-3">
                            <div class="flex items-center gap-2">
                                <div class="font-semibold text-amber-800">${name || '‚Äî'}</div>
                                ${adminBadge}
                            </div>
                            <div class="text-sm text-gray-600">${email}</div>
                        </td>
                        <td class="px-4 py-3">
                            <span class="px-2 py-1 rounded-full text-xs font-bold ${st.cls}">${st.text}</span>
                        </td>
                        <td class="px-4 py-3 text-sm text-gray-700">${safeDate(u.created_at)}</td>
                        <td class="px-4 py-3 text-sm text-gray-700">${safeDate(u.last_sign_in_at)}</td>
                        <td class="px-4 py-3">
                            <div class="flex flex-wrap gap-2 justify-center">
                                ${actionBtn}
                                ${isAdmin ? '<span class="text-xs text-gray-500">‚Äî</span>' : `<button class="bg-gray-800 hover:bg-black text-white px-3 py-2 rounded-lg" onclick="deleteAuthUserAdmin('${u.id}', '${email.replace(/'/g, "\\'")}')">Eliminar</button>`}
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        async function getAdminAccessToken() {
            try {
                const { data, error } = await supabaseClient.auth.getSession();
                if (error) return null;

                let session = data?.session || null;
                const expMs = session?.expires_at ? Number(session.expires_at) * 1000 : 0;
                if (session && expMs && expMs < Date.now() + 60 * 1000) {
                    const refreshed = await supabaseClient.auth.refreshSession();
                    session = refreshed?.data?.session || session;
                }

                return session?.access_token || null;
            } catch (e) {
                return null;
            }
        }

        async function loadAuthUsersAdmin() {
            const status = document.getElementById('auth-users-status');
            const tbody = document.getElementById('auth-users-list');
            if (tbody) {
                tbody.innerHTML = '<tr><td colspan="5" class="px-4 py-8 text-center text-gray-500">Cargando...</td></tr>';
            }
            if (status) status.textContent = 'Cargando cuentas...';

            try {
                const token = await getAdminAccessToken();
                if (!token) throw new Error('Sesi√≥n no v√°lida. Vuelve a iniciar sesi√≥n.');

                const q = String(document.getElementById('auth-users-search')?.value || '').trim();
                const resp = await fetch(`/.netlify/functions/admin-auth-users?perPage=200&q=${encodeURIComponent(q)}`, {
                    method: 'GET',
                    headers: { Authorization: `Bearer ${token}` }
                });
                const payload = await resp.json().catch(() => ({}));
                if (!resp.ok) throw new Error(payload.error || resp.statusText);

                authUsersCache = Array.isArray(payload.users) ? payload.users : [];
                if (status) status.textContent = `Total: ${authUsersCache.length}`;
                filterAuthUsersAdmin();
            } catch (e) {
                if (status) status.textContent = 'Error: ' + (e.message || String(e));
                if (tbody) tbody.innerHTML = '<tr><td colspan="5" class="px-4 py-8 text-center text-red-600">No se pudieron cargar las cuentas</td></tr>';
            }
        }

        function filterAuthUsersAdmin() {
            const q = String(document.getElementById('auth-users-search')?.value || '').trim().toLowerCase();
            const filter = String(document.getElementById('auth-users-filter')?.value || 'all');

            let list = Array.isArray(authUsersCache) ? [...authUsersCache] : [];

            if (q) {
                list = list.filter(u => {
                    const email = String(u.email || '').toLowerCase();
                    const name = String(u.user_metadata?.name || '').toLowerCase();
                    return email.includes(q) || name.includes(q);
                });
            }

            if (filter === 'confirmed') {
                list = list.filter(u => !!(u.email_confirmed_at || u.confirmed_at) && !u.banned_until);
            }
            if (filter === 'unconfirmed') {
                list = list.filter(u => !(u.email_confirmed_at || u.confirmed_at) && !u.banned_until);
            }
            if (filter === 'banned') {
                list = list.filter(u => !!u.banned_until);
            }

            renderAuthUsersAdmin(list);
        }

        async function banAuthUserAdmin(userId) {
            if (!confirm('¬øBanear esta cuenta?')) return;
            const token = await getAdminAccessToken();
            if (!token) return alert('Sesi√≥n no v√°lida.');
            const resp = await fetch('/.netlify/functions/admin-auth-users', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${token}` },
                body: JSON.stringify({ action: 'ban', userId })
            });
            const payload = await resp.json().catch(() => ({}));
            if (!resp.ok) return alert('Error: ' + (payload.error || resp.statusText));
            await loadAuthUsersAdmin();
        }

        async function unbanAuthUserAdmin(userId) {
            if (!confirm('¬øQuitar ban a esta cuenta?')) return;
            const token = await getAdminAccessToken();
            if (!token) return alert('Sesi√≥n no v√°lida.');
            const resp = await fetch('/.netlify/functions/admin-auth-users', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${token}` },
                body: JSON.stringify({ action: 'unban', userId })
            });
            const payload = await resp.json().catch(() => ({}));
            if (!resp.ok) return alert('Error: ' + (payload.error || resp.statusText));
            await loadAuthUsersAdmin();
        }

        async function deleteAuthUserAdmin(userId, email) {
            if (!confirm(`Eliminar definitivamente la cuenta ${email || ''}?`)) return;
            const token = await getAdminAccessToken();
            if (!token) return alert('Sesi√≥n no v√°lida.');
            const resp = await fetch('/.netlify/functions/admin-auth-users', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${token}` },
                body: JSON.stringify({ action: 'delete', userId })
            });
            const payload = await resp.json().catch(() => ({}));
            if (!resp.ok) return alert('Error: ' + (payload.error || resp.statusText));
            await loadAuthUsersAdmin();
        }

        async function assignTableNumber(reservationId, currentMesa) {
            const mesa = prompt('N√∫mero de mesa:', String(currentMesa || '').trim());
            const mesaClean = String(mesa || '').trim();
            if (!mesaClean) return;

            const { error } = await supabaseClient
                .from('reservations')
                .update({ mesa: mesaClean })
                .eq('id', reservationId);

            if (error) {
                alert('Error asignando mesa: ' + error.message);
                return;
            }

            await loadReservations();
        }

        async function uploadTablePhoto(reservationId) {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.capture = 'environment';
            input.onchange = async () => {
                const file = input.files && input.files[0];
                if (!file) return;

                try {
                    const bucket = 'reservation-photos';
                    const path = `reservation_${reservationId}/${Date.now()}_${file.name}`;

                    const up = await supabaseClient.storage
                        .from(bucket)
                        .upload(path, file, { upsert: true, contentType: file.type });

                    if (up.error) {
                        throw new Error(up.error.message);
                    }

                    const { error } = await supabaseClient
                        .from('reservations')
                        .update({ mesa_foto_url: path })
                        .eq('id', reservationId);

                    if (error) {
                        throw new Error(error.message);
                    }

                    await loadReservations();
                    alert('‚úÖ Foto guardada en la reserva');
                } catch (e) {
                    alert('Error subiendo foto. Aseg√∫rate de crear el bucket "reservation-photos" (privado, con policies) y la columna reservations.mesa_foto_url en Supabase. Detalle: ' + (e.message || e));
                }
            };
            input.click();
        }

        async function viewReservationPhoto(path) {
            const p = String(path || '').trim();
            if (!p) return;
            try {
                const bucket = 'reservation-photos';
                const { data, error } = await supabaseClient.storage.from(bucket).createSignedUrl(p, 60 * 10);
                if (error) throw new Error(error.message);
                const url = String(data?.signedUrl || '').trim();
                if (!url) throw new Error('No se pudo generar la URL firmada.');
                window.open(url, '_blank', 'noopener,noreferrer');
            } catch (e) {
                alert('No se pudo abrir la foto. Detalle: ' + (e.message || e));
            }
        }

        async function loadBasementAnalytics() {
            const statusEl = document.getElementById('basement-status');
            const tbodyDaily = document.getElementById('basement-daily');
            const tbodyCustomers = document.getElementById('basement-customers');

            if (statusEl) statusEl.textContent = 'Cargando...';
            if (tbodyDaily) tbodyDaily.innerHTML = '<tr><td colspan="3" class="px-3 py-6 text-center text-gray-500">Cargando...</td></tr>';
            if (tbodyCustomers) tbodyCustomers.innerHTML = '<tr><td colspan="3" class="px-3 py-6 text-center text-gray-500">Cargando...</td></tr>';

            const accessToken = await getAdminAccessToken();
            if (!accessToken) {
                if (statusEl) statusEl.textContent = 'Sesi√≥n inv√°lida. Vuelve a iniciar sesi√≥n.';
                return;
            }

            const days = Number(document.getElementById('basement-days')?.value || 30);
            const top = Number(document.getElementById('basement-top')?.value || 30);

            try {
                const resp = await fetch(`/.netlify/functions/basement-analytics?days=${encodeURIComponent(days)}&top=${encodeURIComponent(top)}`, {
                    method: 'GET',
                    headers: { 'Authorization': 'Bearer ' + accessToken }
                });

                const data = await resp.json().catch(() => ({}));
                if (!resp.ok) {
                    if (statusEl) statusEl.textContent = data.error || 'No se pudo cargar.';
                    return;
                }

                const daily = Array.isArray(data.daily) ? data.daily : [];
                const customers = Array.isArray(data.customers) ? data.customers : [];

                if (tbodyDaily) {
                    if (daily.length === 0) {
                        tbodyDaily.innerHTML = '<tr><td colspan="3" class="px-3 py-6 text-center text-gray-500">Sin datos</td></tr>';
                    } else {
                        tbodyDaily.innerHTML = daily.map(r => `
                            <tr class="border-t">
                                <td class="px-3 py-2">${r.date}</td>
                                <td class="px-3 py-2">${r.sold}</td>
                                <td class="px-3 py-2">${Number(r.revenue_pln || 0).toFixed(0)}</td>
                            </tr>
                        `).join('');
                    }
                }

                if (tbodyCustomers) {
                    if (customers.length === 0) {
                        tbodyCustomers.innerHTML = '<tr><td colspan="3" class="px-3 py-6 text-center text-gray-500">Sin datos</td></tr>';
                    } else {
                        tbodyCustomers.innerHTML = customers.map(c => `
                            <tr class="border-t">
                                <td class="px-3 py-2">${c.email}</td>
                                <td class="px-3 py-2">${c.covers}</td>
                                <td class="px-3 py-2">${c.reservations === null ? '-' : c.reservations}</td>
                            </tr>
                        `).join('');
                    }
                }

                if (statusEl) statusEl.textContent = `OK (${data.range_days || days} d√≠as)`;
            } catch (e) {
                if (statusEl) statusEl.textContent = e.message || String(e);
            }
        }

        function updateOwnerControls(email) {
            const clearBtn = document.getElementById('btn-clear-analytics');
            if (!clearBtn) return;

            if (String(email || '').trim().toLowerCase() === 'sebastian.aguilargutierrez@gmail.com') {
                clearBtn.classList.remove('hidden');
            } else {
                clearBtn.classList.add('hidden');
            }
        }
        
        // Logout
        async function logout() {
            await supabaseClient.auth.signOut();
            document.getElementById('login-section').classList.remove('hidden');
            document.getElementById('admin-panel').classList.add('hidden');
            document.getElementById('user-info').classList.add('hidden');
            document.getElementById('login-form').reset();
            document.getElementById('login-error').classList.add('hidden');
        }
        
        // Cargar reservas
        async function loadReservations() {
            const { data, error } = await supabaseClient
                .from('reservations')
                .select('*')
                .order('fecha', { ascending: false })
                .order('created_at', { ascending: false });
            
            if (error) {
                console.error('Error cargando reservas:', error);
                return;
            }
            
            reservations = data;
            updateStats();
            renderReservations();
        }
        
        // Actualizar estad√≠sticas
        function updateStats() {
            const total = reservations.length;
            const pendientes = reservations.filter(r => r.estado === 'pendiente').length;
            const confirmadas = reservations.filter(r => r.estado === 'confirmada').length;
            const canceladas = reservations.filter(r => r.estado === 'cancelada').length;
            
            document.getElementById('stat-total').textContent = total;
            document.getElementById('stat-pendientes').textContent = pendientes;
            document.getElementById('stat-confirmadas').textContent = confirmadas;
            document.getElementById('stat-canceladas').textContent = canceladas;
        }
        
        // Renderizar reservas
        function renderReservations() {
            const container = document.getElementById('reservations-list');
            const dateFilter = document.getElementById('filter-date').value;
            
            let filtered = reservations;
            
            if (currentFilter !== 'all') {
                filtered = filtered.filter(r => r.estado === currentFilter);
            }
            
            if (dateFilter) {
                filtered = filtered.filter(r => r.fecha === dateFilter);
            }
            
            if (filtered.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-8">No hay reservas para mostrar</p>';
                return;
            }
            
            container.innerHTML = filtered.map(r => `
                <div class="reservation-card ${r.estado}">
                    <div class="flex flex-wrap justify-between items-start gap-4">
                        <div class="flex-1">
                            <div class="flex items-center gap-3 mb-2">
                                <h3 class="text-lg font-bold text-amber-800">${r.nombre}</h3>
                                <span class="status-badge status-${r.estado}">${r.estado}</span>
                            </div>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-2 text-sm text-gray-600">
                                <p><strong>üìÖ Fecha:</strong> ${formatDate(r.fecha)}</p>
                                <p><strong>üïê Hora:</strong> ${r.hora_entrada || 'No especificada'}</p>
                                <p><strong>üë• Personas:</strong> ${r.personas}</p>
                                <p><strong>ü™ë Mesa:</strong> ${r.mesa || 'Sin asignar'}</p>
                            </div>
                            <div class="mt-2 text-sm text-gray-600">
                                <p><strong>üìß</strong> ${r.email} | <strong>üì±</strong> ${r.telefono || 'No proporcionado'}</p>
                                ${r.comentarios ? `<p class="mt-1"><strong>üí¨</strong> ${r.comentarios}</p>` : ''}
                                ${r.mesa_foto_url ? `
                                    <div class="mt-2">
                                        <button onclick="viewReservationPhoto('${String(r.mesa_foto_url || '').replace(/'/g, "\\'")}')" class="text-amber-700 font-bold underline">üì∑ Ver foto de mesa</button>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                        <div class="flex gap-2">
                            ${r.estado === 'pendiente' ? `
                                <button onclick="updateStatus('${r.id}', 'confirmada')" 
                                    class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg transition-colors">
                                    ‚úì Confirmar
                                </button>
                                <button onclick="updateStatus('${r.id}', 'cancelada')"
                                    class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition-colors">
                                    ‚úï Cancelar
                                </button>
                            ` : ''}
                            ${r.estado === 'confirmada' ? `
                                <button onclick="updateStatus('${r.id}', 'cancelada')"
                                    class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition-colors">
                                    ‚úï Cancelar
                                </button>
                            ` : ''}
                            ${r.estado === 'cancelada' ? `
                                <button onclick="updateStatus('${r.id}', 'pendiente')"
                                    class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-lg transition-colors">
                                    ‚Ü∫ Reactivar
                                </button>
                            ` : ''}

                            <button onclick="assignTableNumber('${r.id}', '${String(r.mesa || '').replace(/'/g, "\\'")}')"
                                class="bg-amber-600 hover:bg-amber-700 text-white px-4 py-2 rounded-lg transition-colors">
                                ü™ë Mesa
                            </button>

                            <button onclick="uploadTablePhoto('${r.id}')"
                                class="bg-slate-700 hover:bg-slate-800 text-white px-4 py-2 rounded-lg transition-colors">
                                üì∑ Foto
                            </button>

                            <button onclick="deleteReservation('${r.id}')"
                                class="bg-gray-800 hover:bg-black text-white px-4 py-2 rounded-lg transition-colors">
                                üóëÔ∏è Eliminar
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        // Formatear fecha
        function formatDate(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleDateString('es-ES', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
        }
        
        // Actualizar estado de reserva
        async function updateStatus(id, newStatus) {
            const current = Array.isArray(reservations) ? reservations.find(r => String(r.id) === String(id)) : null;
            const updatePayload = { estado: newStatus };

            if (newStatus === 'confirmada') {
                const existingMesa = String(current?.mesa || '').trim();
                if (!existingMesa) {
                    const mesa = prompt('Para confirmar, asigna el n√∫mero de mesa:');
                    const mesaClean = String(mesa || '').trim();
                    if (!mesaClean) {
                        alert('Debes asignar un n√∫mero de mesa antes de confirmar.');
                        return;
                    }
                    updatePayload.mesa = mesaClean;
                }
            }

            const { data, error } = await supabaseClient
                .from('reservations')
                .update(updatePayload)
                .eq('id', id)
                .select();
            
            if (error) {
                alert('Error al actualizar: ' + error.message);
                return;
            }

            const updated = Array.isArray(data) ? data[0] : null;
            if (updated && newStatus === 'confirmada') {
                try {
                    await sendReservationConfirmationEmail(updated);
                    alert('‚úÖ Email enviado al cliente: Reserva confirmada');
                } catch (e) {
                    alert('La reserva fue confirmada, pero fall√≥ el env√≠o del email: ' + (e.message || e));
                }
            }

            if (updated && newStatus === 'cancelada') {
                try {
                    await sendReservationCancellationEmail(updated);
                    alert('‚úÖ Email enviado al cliente: Reserva cancelada');
                } catch (e) {
                    alert('La reserva fue cancelada, pero fall√≥ el env√≠o del email: ' + (e.message || e));
                }
            }

            if (updated && newStatus === 'pendiente' && String(current?.estado || '') === 'cancelada') {
                try {
                    await sendReservationReactivatedEmail(updated);
                    alert('‚úÖ Email enviado al cliente: Reserva reactivada');
                } catch (e) {
                    alert('La reserva fue reactivada, pero fall√≥ el env√≠o del email: ' + (e.message || e));
                }
            }
            
            // Recargar reservas
            await loadReservations();
        }

        function showManualReservationModal() {
            const modal = document.getElementById('manual-reservation-modal');
            const form = document.getElementById('manual-reservation-form');
            if (form) form.reset();
            const estado = document.getElementById('manual-reservation-estado');
            if (estado) estado.value = 'confirmada';
            const sendEmail = document.getElementById('manual-reservation-send-email');
            if (sendEmail) sendEmail.checked = true;
            if (modal) modal.classList.remove('hidden');
        }

        function closeManualReservationModal() {
            const modal = document.getElementById('manual-reservation-modal');
            if (modal) modal.classList.add('hidden');
        }

        function formatDateShort(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleDateString('es-ES', { year: 'numeric', month: '2-digit', day: '2-digit' });
        }

        async function sendReservationConfirmationEmail(reservation) {
            const email = String(reservation?.email || '').trim();
            if (!email) return;

            const accessToken = await getAdminAccessToken();
            if (!accessToken) return;

            const subject = '‚úÖ Reserva confirmada - Macondo';
            const content = [
                `Reserva confirmada`,
                `Nombre: ${reservation.nombre || ''}`,
                `Email: ${reservation.email || ''}`,
                `Tel√©fono: ${reservation.telefono || ''}`,
                `Fecha: ${reservation.fecha ? formatDateShort(reservation.fecha) : ''}`,
                `Hora: ${reservation.hora_entrada || ''}`,
                `Personas: ${reservation.personas || ''}`,
                `Mesa: ${reservation.mesa || 'Sin asignar'}`,
                reservation.comentarios ? `Comentarios: ${reservation.comentarios}` : ''
            ].filter(Boolean).join('\n');

            const logoUrl = `${window.location.origin}/logoamarillo.png`;
            const photoUrl = String(reservation?.mesa_foto_url || '').trim();
            const safe = (s) => String(s ?? '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#039;');
            const html = `
                <div style="font-family:Arial,sans-serif;line-height:1.5;color:#1f2937">
                  <div style="text-align:center;margin-bottom:16px">
                    <img src="${logoUrl}" alt="Macondo" style="max-width:220px;width:70%;height:auto" />
                  </div>
                  <h2 style="color:#92400e;margin:0 0 12px 0">‚úÖ Tu reserva ha sido confirmada</h2>
                  <p style="margin:0 0 16px 0">Hola <strong>${safe(reservation.nombre || '')}</strong>, te confirmamos tu reserva en <strong>Macondo</strong>.</p>
                  <table cellpadding="0" cellspacing="0" style="width:100%;border-collapse:collapse">
                    <tr><td style="padding:8px 0;border-bottom:1px solid #f3f4f6"><strong>Fecha</strong></td><td style="padding:8px 0;border-bottom:1px solid #f3f4f6">${safe(reservation.fecha ? formatDateShort(reservation.fecha) : '')}</td></tr>
                    <tr><td style="padding:8px 0;border-bottom:1px solid #f3f4f6"><strong>Hora</strong></td><td style="padding:8px 0;border-bottom:1px solid #f3f4f6">${safe(reservation.hora_entrada || '')}</td></tr>
                    <tr><td style="padding:8px 0;border-bottom:1px solid #f3f4f6"><strong>Personas</strong></td><td style="padding:8px 0;border-bottom:1px solid #f3f4f6">${safe(reservation.personas || '')}</td></tr>
                    <tr><td style="padding:8px 0;border-bottom:1px solid #f3f4f6"><strong>Mesa</strong></td><td style="padding:8px 0;border-bottom:1px solid #f3f4f6">${safe(reservation.mesa || 'Sin asignar')}</td></tr>
                    ${reservation.comentarios ? `<tr><td style="padding:8px 0;border-bottom:1px solid #f3f4f6"><strong>Comentarios</strong></td><td style="padding:8px 0;border-bottom:1px solid #f3f4f6">${safe(reservation.comentarios)}</td></tr>` : ''}
                  </table>
                  ${photoUrl ? `
                    <div style="margin-top:16px">
                      <div style="font-weight:700;margin-bottom:8px">üì∑ Foto de mesa</div>
                      <a href="${photoUrl}">${photoUrl}</a>
                      <div style="margin-top:8px"><img src="${photoUrl}" alt="Foto de mesa" style="max-width:520px;width:100%;height:auto;border-radius:12px;border:1px solid #f3f4f6" /></div>
                    </div>
                  ` : ''}
                  <p style="margin:16px 0 0 0">Gracias,<br><strong>Macondo Bar Latino</strong></p>
                </div>
            `;

            const resp = await fetch('/.netlify/functions/send-email', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + accessToken
                },
                body: JSON.stringify({
                    mode: 'single',
                    toEmail: email,
                    toName: reservation.nombre || email,
                    subject,
                    content,
                    html
                })
            });

            const data = await resp.json().catch(() => ({}));
            if (!resp.ok) {
                throw new Error(data.error || resp.statusText);
            }
        }

        async function sendReservationCancellationEmail(reservation) {
            const email = String(reservation?.email || '').trim();
            if (!email) return;

            const accessToken = await getAdminAccessToken();
            if (!accessToken) return;

            const subject = '‚ùå Reserva cancelada - Macondo';
            const content = [
                `Reserva cancelada`,
                `Nombre: ${reservation.nombre || ''}`,
                `Email: ${reservation.email || ''}`,
                `Tel√©fono: ${reservation.telefono || ''}`,
                `Fecha: ${reservation.fecha ? formatDateShort(reservation.fecha) : ''}`,
                `Hora: ${reservation.hora_entrada || ''}`,
                `Personas: ${reservation.personas || ''}`,
                `Mesa: ${reservation.mesa || 'Sin asignar'}`,
                reservation.comentarios ? `Comentarios: ${reservation.comentarios}` : ''
            ].filter(Boolean).join('\n');

            const logoUrl = `${window.location.origin}/logoamarillo.png`;
            const photoUrl = String(reservation?.mesa_foto_url || '').trim();
            const safe = (s) => String(s ?? '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#039;');
            const html = `
                <div style="font-family:Arial,sans-serif;line-height:1.5;color:#1f2937">
                  <div style="text-align:center;margin-bottom:16px">
                    <img src="${logoUrl}" alt="Macondo" style="max-width:220px;width:70%;height:auto" />
                  </div>
                  <h2 style="color:#b91c1c;margin:0 0 12px 0">‚ùå Tu reserva ha sido cancelada</h2>
                  <p style="margin:0 0 16px 0">Hola <strong>${safe(reservation.nombre || '')}</strong>, te informamos que tu reserva en <strong>Macondo</strong> ha sido cancelada.</p>
                  <table cellpadding="0" cellspacing="0" style="width:100%;border-collapse:collapse">
                    <tr><td style="padding:8px 0;border-bottom:1px solid #f3f4f6"><strong>Fecha</strong></td><td style="padding:8px 0;border-bottom:1px solid #f3f4f6">${safe(reservation.fecha ? formatDateShort(reservation.fecha) : '')}</td></tr>
                    <tr><td style="padding:8px 0;border-bottom:1px solid #f3f4f6"><strong>Hora</strong></td><td style="padding:8px 0;border-bottom:1px solid #f3f4f6">${safe(reservation.hora_entrada || '')}</td></tr>
                    <tr><td style="padding:8px 0;border-bottom:1px solid #f3f4f6"><strong>Personas</strong></td><td style="padding:8px 0;border-bottom:1px solid #f3f4f6">${safe(reservation.personas || '')}</td></tr>
                    <tr><td style="padding:8px 0;border-bottom:1px solid #f3f4f6"><strong>Mesa</strong></td><td style="padding:8px 0;border-bottom:1px solid #f3f4f6">${safe(reservation.mesa || 'Sin asignar')}</td></tr>
                    ${reservation.comentarios ? `<tr><td style="padding:8px 0;border-bottom:1px solid #f3f4f6"><strong>Comentarios</strong></td><td style="padding:8px 0;border-bottom:1px solid #f3f4f6">${safe(reservation.comentarios)}</td></tr>` : ''}
                  </table>
                  ${photoUrl ? `
                    <div style="margin-top:16px">
                      <div style="font-weight:700;margin-bottom:8px">üì∑ Foto de mesa (interno)</div>
                      <a href="${photoUrl}">${photoUrl}</a>
                      <div style="margin-top:8px"><img src="${photoUrl}" alt="Foto de mesa" style="max-width:520px;width:100%;height:auto;border-radius:12px;border:1px solid #f3f4f6" /></div>
                    </div>
                  ` : ''}
                  <p style="margin:16px 0 0 0">Gracias,<br><strong>Macondo Bar Latino</strong></p>
                </div>
            `;

            const resp = await fetch('/.netlify/functions/send-email', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + accessToken
                },
                body: JSON.stringify({
                    mode: 'single',
                    toEmail: email,
                    toName: reservation.nombre || email,
                    subject,
                    content,
                    html
                })
            });

            const data = await resp.json().catch(() => ({}));
            if (!resp.ok) {
                throw new Error(data.error || resp.statusText);
            }
        }

        const manualReservationForm = document.getElementById('manual-reservation-form');
        if (manualReservationForm) {
            manualReservationForm.addEventListener('submit', async (e) => {
                e.preventDefault();

                const nombre = String(document.getElementById('manual-reservation-nombre')?.value || '').trim();
                const email = String(document.getElementById('manual-reservation-email')?.value || '').trim();
                const telefono = String(document.getElementById('manual-reservation-telefono')?.value || '').trim();
                const fecha = String(document.getElementById('manual-reservation-fecha')?.value || '').trim();
                const hora = String(document.getElementById('manual-reservation-hora')?.value || '').trim();
                const personas = Number(document.getElementById('manual-reservation-personas')?.value || 1);
                const mesa = String(document.getElementById('manual-reservation-mesa')?.value || '').trim();
                const comentarios = String(document.getElementById('manual-reservation-comentarios')?.value || '').trim();
                const estado = String(document.getElementById('manual-reservation-estado')?.value || 'pendiente').trim();
                const shouldSendEmail = !!document.getElementById('manual-reservation-send-email')?.checked;

                if (!nombre || !email || !fecha || !personas) return;
                if (estado === 'confirmada' && !mesa) {
                    alert('Para crear una reserva confirmada, debes asignar el n√∫mero de mesa.');
                    return;
                }

                const insertData = {
                    nombre,
                    email,
                    telefono: telefono || null,
                    fecha,
                    hora_entrada: hora || null,
                    personas,
                    mesa: mesa || null,
                    comentarios: comentarios || null,
                    estado,
                    created_at: new Date().toISOString()
                };

                const { data, error } = await supabaseClient
                    .from('reservations')
                    .insert([insertData])
                    .select();

                if (error) {
                    alert('Error creando reserva: ' + error.message);
                    return;
                }

                const created = Array.isArray(data) ? data[0] : null;
                if (created && created.estado === 'confirmada' && shouldSendEmail) {
                    try {
                        await sendReservationConfirmationEmail(created);
                        alert('‚úÖ Email enviado al cliente: Reserva confirmada');
                    } catch (e) {
                        alert('Reserva creada, pero fall√≥ el email: ' + (e.message || e));
                    }
                }

                closeManualReservationModal();
                await loadReservations();
            });
        }

        async function deleteReservation(id) {
            if (!confirm('¬øEst√°s seguro de eliminar esta reserva? Esta acci√≥n no se puede deshacer.')) return;

            const { error } = await supabaseClient
                .from('reservations')
                .delete()
                .eq('id', id);

            if (error) {
                alert('Error al eliminar: ' + error.message);
                return;
            }

            await loadReservations();
        }
        
        // Configurar filtros
        function setupFilters() {
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentFilter = btn.dataset.filter;
                    renderReservations();
                });
            });
            
            document.getElementById('filter-date').addEventListener('change', () => {
                renderReservations();
            });
        }
        
        // ==================== PEDIDOS ====================
        
        // Cargar pedidos
        async function loadOrders() {
            const { data, error } = await supabaseClient
                .from('orders')
                .select('*')
                .order('created_at', { ascending: false });
            
            if (error) {
                console.error('Error cargando pedidos:', error);
                document.getElementById('orders-list').innerHTML = '<p class="text-gray-500 text-center py-8">No se pudieron cargar los pedidos. Verifica que la tabla "orders" existe.</p>';
                return;
            }
            
            orders = data || [];
            updateOrderStats();
            renderOrders();
        }
        
        // Actualizar estad√≠sticas de pedidos
        function updateOrderStats() {
            const total = orders.length;
            const pendientes = orders.filter(o => o.status === 'pendiente').length;
            const preparacion = orders.filter(o => o.status === 'preparacion').length;
            const completados = orders.filter(o => o.status === 'completado').length;
            
            document.getElementById('stat-orders-total').textContent = total;
            document.getElementById('stat-orders-pendientes').textContent = pendientes;
            document.getElementById('stat-orders-preparacion').textContent = preparacion;
            document.getElementById('stat-orders-completados').textContent = completados;
        }
        
        // Renderizar pedidos
        function renderOrders() {
            const container = document.getElementById('orders-list');
            
            let filtered = orders;
            
            if (currentOrderFilter !== 'all') {
                filtered = filtered.filter(o => o.status === currentOrderFilter);
            }
            
            if (filtered.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-8">No hay pedidos para mostrar</p>';
                return;
            }
            
            container.innerHTML = filtered.map(o => {
                const items = typeof o.items === 'string' ? JSON.parse(o.items) : o.items;
                const itemsList = Array.isArray(items) ? items.map(i => `${i.name} x${i.quantity || 1}`).join(', ') : 'Sin items';
                
                return `
                <div class="reservation-card ${o.status === 'completado' ? 'confirmada' : o.status === 'cancelado' ? 'cancelada' : ''}">
                    <div class="flex flex-wrap justify-between items-start gap-4">
                        <div class="flex-1">
                            <div class="flex items-center gap-3 mb-2">
                                <h3 class="text-lg font-bold text-amber-800">${o.customer_name}</h3>
                                <span class="status-badge status-${o.status === 'preparacion' ? 'pendiente' : o.status === 'completado' ? 'confirmada' : o.status}">${o.status}</span>
                                <span class="text-sm text-gray-500">#${o.id.slice(0, 8)}</span>
                            </div>
                            <div class="text-sm text-gray-600 mb-2">
                                <p><strong>üõí Items:</strong> ${itemsList}</p>
                                <p><strong>üí∞ Total:</strong> ${o.total} PLN</p>
                            </div>
                            <div class="text-sm text-gray-600">
                                <p><strong>üìß</strong> ${o.customer_email} ${o.customer_phone ? `| <strong>üì±</strong> ${o.customer_phone}` : ''}</p>
                                <p><strong>üïê</strong> ${new Date(o.created_at).toLocaleString('es-ES')}</p>
                            </div>
                        </div>
                        <div class="flex gap-2 flex-wrap">
                            ${o.status === 'pendiente' ? `
                                <button onclick="updateOrderStatus('${o.id}', 'preparacion')" 
                                    class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-colors">
                                    üë®‚Äçüç≥ Preparar
                                </button>
                                <button onclick="updateOrderStatus('${o.id}', 'cancelado')"
                                    class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition-colors">
                                    ‚úï Cancelar
                                </button>
                            ` : ''}
                            ${o.status === 'preparacion' ? `
                                <button onclick="updateOrderStatus('${o.id}', 'completado')" 
                                    class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg transition-colors">
                                    ‚úì Completado
                                </button>
                            ` : ''}
                            ${o.status === 'cancelado' ? `
                                <button onclick="updateOrderStatus('${o.id}', 'pendiente')"
                                    class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-lg transition-colors">
                                    ‚Ü∫ Reactivar
                                </button>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `}).join('');
        }
        
        // Actualizar estado de pedido
        async function updateOrderStatus(id, newStatus) {
            const { error } = await supabaseClient
                .from('orders')
                .update({ status: newStatus })
                .eq('id', id);
            
            if (error) {
                alert('Error al actualizar: ' + error.message);
                return;
            }
            
            await loadOrders();
        }
        
        // Configurar filtros de pedidos
        function setupOrderFilters() {
            document.querySelectorAll('.order-filter-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.order-filter-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentOrderFilter = btn.dataset.filter;
                    renderOrders();
                });
            });
        }
        
        // ==================== EVENTOS ====================
        
        // Cargar eventos
        async function loadEvents() {
            const { data, error } = await supabaseClient
                .from('events')
                .select('*')
                .order('fecha', { ascending: true });
            
            if (error) {
                console.error('Error cargando eventos:', error);
                document.getElementById('events-list').innerHTML = '<p class="text-gray-500 text-center py-8">No se pudieron cargar los eventos. Verifica que la tabla "events" existe.</p>';
                return;
            }
            
            events = data || [];
            updateEventStats();
            renderEvents();
        }
        
        // Actualizar estad√≠sticas de eventos
        function updateEventStats() {
            const total = events.length;
            const activos = events.filter(e => e.activo).length;
            const hoy = new Date();
            const en7dias = new Date(hoy.getTime() + 7 * 24 * 60 * 60 * 1000);
            const proximos = events.filter(e => {
                const fechaEvento = new Date(e.fecha);
                return fechaEvento >= hoy && fechaEvento <= en7dias && e.activo;
            }).length;
            
            document.getElementById('stat-events-total').textContent = total;
            document.getElementById('stat-events-activos').textContent = activos;
            document.getElementById('stat-events-proximos').textContent = proximos;
        }
        
        // Renderizar eventos
        function renderEvents() {
            const container = document.getElementById('events-list');
            
            if (events.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-8">No hay eventos. ¬°Crea el primero!</p>';
                return;
            }
            
            container.innerHTML = events.map(e => `
                <div class="reservation-card ${e.activo ? '' : 'cancelada'}">
                    <div class="flex flex-wrap gap-4">
                        ${e.imagen_url ? `<img src="${e.imagen_url}" alt="${e.titulo}" class="w-32 h-24 object-cover rounded-lg">` : ''}
                        <div class="flex-1">
                            <div class="flex items-center gap-3 mb-2">
                                <h3 class="text-lg font-bold text-amber-800">${e.titulo}</h3>
                                <span class="status-badge ${e.activo ? 'status-confirmada' : 'status-cancelada'}">${e.activo ? 'Activo' : 'Inactivo'}</span>
                            </div>
                            <p class="text-gray-600 text-sm mb-2">${e.descripcion || 'Sin descripci√≥n'}</p>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-2 text-sm text-gray-600">
                                <p><strong>üìÖ</strong> ${formatDate(e.fecha)}</p>
                                <p><strong>üïê</strong> ${e.hora || 'Sin hora'}</p>
                                <p><strong>üìç</strong> ${e.ubicacion || 'Macondo'}</p>
                                <p><strong>üí∞</strong> ${e.precio || 'Gratis'}</p>
                            </div>
                        </div>
                        <div class="flex flex-col gap-2">
                            <button onclick="editEvent('${e.id}')" 
                                class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-colors text-sm">
                                ‚úèÔ∏è Editar
                            </button>
                            <button onclick="toggleEventActive('${e.id}', ${!e.activo})" 
                                class="${e.activo ? 'bg-yellow-500 hover:bg-yellow-600' : 'bg-green-500 hover:bg-green-600'} text-white px-4 py-2 rounded-lg transition-colors text-sm">
                                ${e.activo ? '‚è∏Ô∏è Desactivar' : '‚ñ∂Ô∏è Activar'}
                            </button>
                            <button onclick="deleteEvent('${e.id}')" 
                                class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition-colors text-sm">
                                üóëÔ∏è Eliminar
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        // Mostrar modal de evento
        function showEventModal(eventId = null) {
            document.getElementById('event-modal').classList.remove('hidden');
            document.getElementById('event-form').reset();
            document.getElementById('event-id').value = '';
            document.getElementById('event-activo').checked = true;
            document.getElementById('modal-title').textContent = 'Nuevo Evento';
            
            if (eventId) {
                const event = events.find(e => e.id === eventId);
                if (event) {
                    document.getElementById('modal-title').textContent = 'Editar Evento';
                    document.getElementById('event-id').value = event.id;
                    document.getElementById('event-titulo').value = event.titulo;
                    document.getElementById('event-descripcion').value = event.descripcion || '';
                    document.getElementById('event-fecha').value = event.fecha;
                    document.getElementById('event-hora').value = event.hora || '';
                    document.getElementById('event-imagen').value = event.imagen_url || '';
                    document.getElementById('event-ubicacion').value = event.ubicacion || 'Macondo Bar Latino';
                    document.getElementById('event-precio').value = event.precio || '';
                    document.getElementById('event-activo').checked = event.activo;
                }
            }
        }
        
        // Cerrar modal
        function closeEventModal() {
            document.getElementById('event-modal').classList.add('hidden');
        }
        
        // Editar evento
        function editEvent(id) {
            showEventModal(id);
        }
        
        // Activar/Desactivar evento
        async function toggleEventActive(id, newStatus) {
            const { error } = await supabaseClient
                .from('events')
                .update({ activo: newStatus })
                .eq('id', id);
            
            if (error) {
                alert('Error al actualizar: ' + error.message);
                return;
            }
            
            await loadEvents();
        }
        
        // Eliminar evento
        async function deleteEvent(id) {
            if (!confirm('¬øEst√°s seguro de eliminar este evento? Esta acci√≥n no se puede deshacer.')) {
                return;
            }
            
            const { error } = await supabaseClient
                .from('events')
                .delete()
                .eq('id', id);
            
            if (error) {
                alert('Error al eliminar: ' + error.message);
                return;
            }
            
            await loadEvents();
        }
        
        // ==================== MEN√ö ====================
        
        // Cargar items del men√∫
        async function loadMenuItems() {
            const { data, error } = await supabaseClient
                .from('menu_items')
                .select('*')
                .order('categoria', { ascending: true })
                .order('nombre', { ascending: true });
            
            if (error) {
                console.error('Error cargando men√∫:', error);
                document.getElementById('menu-items-list').innerHTML = '<p class="text-gray-500 text-center py-8">No se pudieron cargar los items. Verifica que la tabla "menu_items" existe.</p>';
                return;
            }
            
            menuItems = data || [];
            updateMenuStats();
            renderMenuItems();
        }
        
        // Actualizar estad√≠sticas del men√∫
        function updateMenuStats() {
            const total = menuItems.length;
            const platos = menuItems.filter(m => m.categoria === 'plato').length;
            const bebidas = menuItems.filter(m => m.categoria === 'bebida').length;
            const activos = menuItems.filter(m => m.activo).length;
            
            document.getElementById('stat-menu-total').textContent = total;
            document.getElementById('stat-menu-platos').textContent = platos;
            document.getElementById('stat-menu-bebidas').textContent = bebidas;
            document.getElementById('stat-menu-activos').textContent = activos;
        }
        
        // Renderizar items del men√∫
        function renderMenuItems() {
            const container = document.getElementById('menu-items-list');
            
            let filtered = menuItems;
            
            if (currentMenuFilter !== 'all') {
                filtered = filtered.filter(m => m.categoria === currentMenuFilter);
            }
            
            if (filtered.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-8">No hay items en el men√∫. ¬°Agrega el primero!</p>';
                return;
            }
            
            container.innerHTML = filtered.map(m => `
                <div class="reservation-card ${m.activo ? '' : 'cancelada'}">
                    <div class="flex flex-wrap gap-4">
                        ${m.imagen_url ? `<img src="${m.imagen_url}" alt="${m.nombre}" class="w-24 h-24 object-cover rounded-lg">` : '<div class="w-24 h-24 bg-gray-200 rounded-lg flex items-center justify-center text-3xl">üçΩÔ∏è</div>'}
                        <div class="flex-1">
                            <div class="flex items-center gap-3 mb-2">
                                <h3 class="text-lg font-bold text-amber-800">${m.nombre}</h3>
                                <span class="status-badge ${m.activo ? 'status-confirmada' : 'status-cancelada'}">${m.activo ? 'Activo' : 'Inactivo'}</span>
                                <span class="text-xs bg-gray-100 px-2 py-1 rounded">${m.categoria}</span>
                            </div>
                            <p class="text-gray-600 text-sm mb-2">${m.descripcion || 'Sin descripci√≥n'}</p>
                            <p class="text-amber-600 font-bold text-lg">${m.precio.toFixed(2)} PLN</p>
                        </div>
                        <div class="flex flex-col gap-2">
                            <button onclick="editMenuItem('${m.id}')" 
                                class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-colors text-sm">
                                ‚úèÔ∏è Editar
                            </button>
                            <button onclick="toggleMenuItemActive('${m.id}', ${!m.activo})" 
                                class="${m.activo ? 'bg-yellow-500 hover:bg-yellow-600' : 'bg-green-500 hover:bg-green-600'} text-white px-4 py-2 rounded-lg transition-colors text-sm">
                                ${m.activo ? '‚è∏Ô∏è Desactivar' : '‚ñ∂Ô∏è Activar'}
                            </button>
                            <button onclick="deleteMenuItem('${m.id}')" 
                                class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition-colors text-sm">
                                üóëÔ∏è Eliminar
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        // Mostrar modal de item del men√∫
        function showMenuItemModal(itemId = null) {
            document.getElementById('menu-item-modal').classList.remove('hidden');
            document.getElementById('menu-item-form').reset();
            document.getElementById('menu-item-id').value = '';
            document.getElementById('menu-item-activo').checked = true;
            document.getElementById('menu-modal-title').textContent = 'Nuevo Plato/Bebida';
            
            if (itemId) {
                const item = menuItems.find(m => m.id === itemId);
                if (item) {
                    document.getElementById('menu-modal-title').textContent = 'Editar Item';
                    document.getElementById('menu-item-id').value = item.id;
                    document.getElementById('menu-item-nombre').value = item.nombre;
                    document.getElementById('menu-item-descripcion').value = item.descripcion || '';
                    document.getElementById('menu-item-precio').value = item.precio;
                    document.getElementById('menu-item-categoria').value = item.categoria;
                    document.getElementById('menu-item-imagen').value = item.imagen_url || '';
                    document.getElementById('menu-item-activo').checked = item.activo;
                }
            }
        }
        
        // Cerrar modal del men√∫
        function closeMenuItemModal() {
            document.getElementById('menu-item-modal').classList.add('hidden');
        }
        
        // Editar item del men√∫
        function editMenuItem(id) {
            showMenuItemModal(id);
        }
        
        // Activar/Desactivar item del men√∫
        async function toggleMenuItemActive(id, newStatus) {
            const { error } = await supabaseClient
                .from('menu_items')
                .update({ activo: newStatus })
                .eq('id', id);
            
            if (error) {
                alert('Error al actualizar: ' + error.message);
                return;
            }
            
            await loadMenuItems();
        }
        
        // Eliminar item del men√∫
        async function deleteMenuItem(id) {
            if (!confirm('¬øEst√°s seguro de eliminar este item? Esta acci√≥n no se puede deshacer.')) {
                return;
            }
            
            const { error } = await supabaseClient
                .from('menu_items')
                .delete()
                .eq('id', id);
            
            if (error) {
                alert('Error al eliminar: ' + error.message);
                return;
            }
            
            await loadMenuItems();
        }
        
        // Configurar filtros del men√∫
        function setupMenuFilters() {
            document.querySelectorAll('.menu-filter-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.menu-filter-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentMenuFilter = btn.dataset.filter;
                    renderMenuItems();
                });
            });
        }
        
        // ==================== SUBIDA DE IM√ÅGENES ====================
        
        // Preview de imagen para men√∫
        function previewMenuImage(input) {
            const preview = document.getElementById('menu-image-preview');
            const img = document.getElementById('menu-preview-img');
            
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    img.src = e.target.result;
                    preview.classList.remove('hidden');
                };
                reader.readAsDataURL(input.files[0]);
                // Limpiar URL si se selecciona archivo
                document.getElementById('menu-item-imagen').value = '';
            }
        }
        
        // Preview de imagen para eventos
        function previewEventImage(input) {
            const preview = document.getElementById('event-image-preview');
            const img = document.getElementById('event-preview-img');
            
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    img.src = e.target.result;
                    preview.classList.remove('hidden');
                };
                reader.readAsDataURL(input.files[0]);
                // Limpiar URL si se selecciona archivo
                document.getElementById('event-imagen').value = '';
            }
        }
        
        // Subir imagen a Supabase Storage
        async function uploadImage(file, folder) {
            const fileExt = file.name.split('.').pop();
            const fileName = `${folder}_${Date.now()}.${fileExt}`;
            const filePath = `${folder}/${fileName}`;
            
            const { data, error } = await supabaseClient.storage
                .from('images')
                .upload(filePath, file, {
                    cacheControl: '3600',
                    upsert: false
                });
            
            if (error) {
                console.error('Error subiendo imagen:', error);
                throw error;
            }
            
            // Obtener URL p√∫blica
            const { data: urlData } = supabaseClient.storage
                .from('images')
                .getPublicUrl(filePath);
            
            return urlData.publicUrl;
        }
        
        // Modificar el submit del formulario de men√∫ para subir imagen
        const originalMenuSubmit = document.getElementById('menu-item-form').onsubmit;
        document.getElementById('menu-item-form').removeEventListener('submit', () => {});
        document.getElementById('menu-item-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const submitBtn = e.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.textContent = 'Guardando...';
            submitBtn.disabled = true;
            
            try {
                let imageUrl = document.getElementById('menu-item-imagen').value || null;
                
                // Si hay archivo seleccionado, subirlo
                const fileInput = document.getElementById('menu-item-file');
                if (fileInput.files && fileInput.files[0]) {
                    try {
                        imageUrl = await uploadImage(fileInput.files[0], 'menu');
                    } catch (uploadError) {
                        alert('Error al subir imagen: ' + uploadError.message + '\nSe guardar√° sin imagen.');
                        imageUrl = null;
                    }
                }
                
                const itemId = document.getElementById('menu-item-id').value;
                const itemData = {
                    nombre: document.getElementById('menu-item-nombre').value,
                    descripcion: document.getElementById('menu-item-descripcion').value || null,
                    precio: parseFloat(document.getElementById('menu-item-precio').value),
                    categoria: document.getElementById('menu-item-categoria').value,
                    imagen_url: imageUrl,
                    activo: document.getElementById('menu-item-activo').checked
                };
                
                let error;
                
                if (itemId) {
                    const result = await supabaseClient
                        .from('menu_items')
                        .update(itemData)
                        .eq('id', itemId);
                    error = result.error;
                } else {
                    const result = await supabaseClient
                        .from('menu_items')
                        .insert([itemData]);
                    error = result.error;
                }
                
                if (error) {
                    alert('Error al guardar: ' + error.message);
                    return;
                }
                
                closeMenuItemModal();
                await loadMenuItems();
                
            } finally {
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            }
        });
        
        // Modificar el submit del formulario de eventos para subir imagen
        document.getElementById('event-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const submitBtn = e.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.textContent = 'Guardando...';
            submitBtn.disabled = true;
            
            try {
                let imageUrl = document.getElementById('event-imagen').value || null;
                
                // Si hay archivo seleccionado, subirlo
                const fileInput = document.getElementById('event-file');
                if (fileInput.files && fileInput.files[0]) {
                    try {
                        imageUrl = await uploadImage(fileInput.files[0], 'events');
                    } catch (uploadError) {
                        alert('Error al subir imagen: ' + uploadError.message + '\nSe guardar√° sin imagen.');
                        imageUrl = null;
                    }
                }
                
                const eventId = document.getElementById('event-id').value;
                const eventData = {
                    titulo: document.getElementById('event-titulo').value,
                    descripcion: document.getElementById('event-descripcion').value || null,
                    fecha: document.getElementById('event-fecha').value,
                    hora: document.getElementById('event-hora').value || null,
                    imagen_url: imageUrl,
                    ubicacion: document.getElementById('event-ubicacion').value || 'Macondo Bar Latino',
                    precio: document.getElementById('event-precio').value || null,
                    activo: document.getElementById('event-activo').checked
                };
                
                let error;
                
                if (eventId) {
                    const result = await supabaseClient
                        .from('events')
                        .update(eventData)
                        .eq('id', eventId);
                    error = result.error;
                } else {
                    const result = await supabaseClient
                        .from('events')
                        .insert([eventData]);
                    error = result.error;
                }
                
                if (error) {
                    alert('Error al guardar: ' + error.message);
                    return;
                }
                
                closeEventModal();
                await loadEvents();
                
            } finally {
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            }
        }, { once: false });
        
        // Limpiar previews al abrir modales
        const originalShowMenuItemModal = showMenuItemModal;
        showMenuItemModal = function(itemId = null) {
            document.getElementById('menu-item-file').value = '';
            document.getElementById('menu-image-preview').classList.add('hidden');
            originalShowMenuItemModal(itemId);
        };
        
        const originalShowEventModal = showEventModal;
        showEventModal = function(eventId = null) {
            document.getElementById('event-file').value = '';
            document.getElementById('event-image-preview').classList.add('hidden');
            originalShowEventModal(eventId);
        };
        
        // ==================== ANAL√çTICAS ====================
        
        let currentAnalyticsPeriod = 'today';
        let analyticsData = [];
        
        // Configurar filtros de per√≠odo
        document.querySelectorAll('.analytics-period-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.analytics-period-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentAnalyticsPeriod = btn.dataset.period;
                loadAnalytics();
            });
        });
        
        // Cargar anal√≠ticas
        async function loadAnalytics() {
            const dateRange = getDateRange(currentAnalyticsPeriod);
            
            try {
                // Cargar datos de analytics
                const { data: analytics, error } = await supabaseClient
                    .from('analytics')
                    .select('*')
                    .gte('created_at', dateRange.start)
                    .lte('created_at', dateRange.end)
                    .order('created_at', { ascending: false });
                
                if (error) {
                    console.error('Error cargando analytics:', error);
                    return;
                }
                
                analyticsData = analytics || [];
                
                // Calcular estad√≠sticas
                updateAnalyticsStats(analyticsData);
                updateDayChart(analyticsData);
                updateTopPages(analyticsData);
                updateDeviceStats(analyticsData);
                updateTrafficSources(analyticsData);
                updateRecentActivity(analyticsData);
                
                // Cargar conversiones (pedidos + reservas)
                await loadConversions(dateRange);
                
            } catch (err) {
                console.error('Error en loadAnalytics:', err);
            }
        }
        
        // Obtener rango de fechas seg√∫n per√≠odo
        function getDateRange(period) {
            const now = new Date();
            let start, end;
            
            switch(period) {
                case 'today':
                    start = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                    end = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59);
                    break;
                case 'week':
                    const dayOfWeek = now.getDay();
                    const diffToMonday = dayOfWeek === 0 ? 6 : dayOfWeek - 1;
                    start = new Date(now.getFullYear(), now.getMonth(), now.getDate() - diffToMonday);
                    end = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59);
                    break;
                case 'month':
                    start = new Date(now.getFullYear(), now.getMonth(), 1);
                    end = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59);
                    break;
                case 'year':
                    start = new Date(now.getFullYear(), 0, 1);
                    end = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59);
                    break;
                default:
                    start = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                    end = now;
            }
            
            return {
                start: start.toISOString(),
                end: end.toISOString()
            };
        }
        
        // Actualizar estad√≠sticas principales
        function updateAnalyticsStats(data) {
            const totalVisits = data.length;
            const uniqueVisitors = new Set(data.map(d => d.visitor_id || d.session_id)).size;
            const pageviews = data.filter(d => d.event_type === 'pageview').length;
            const clicks = data.filter(d => d.event_type === 'click').length;
            
            // Calcular tiempo promedio (en minutos)
            const sessions = {};
            data.forEach(d => {
                const sid = d.session_id;
                if (!sessions[sid]) sessions[sid] = { start: d.created_at, end: d.created_at };
                if (d.created_at < sessions[sid].start) sessions[sid].start = d.created_at;
                if (d.created_at > sessions[sid].end) sessions[sid].end = d.created_at;
            });
            
            let totalTime = 0;
            Object.values(sessions).forEach(s => {
                totalTime += (new Date(s.end) - new Date(s.start)) / 1000 / 60;
            });
            const avgTime = Object.keys(sessions).length > 0 ? totalTime / Object.keys(sessions).length : 0;
            
            // Tasa de rebote (sesiones con solo 1 evento)
            const sessionCounts = {};
            data.forEach(d => {
                sessionCounts[d.session_id] = (sessionCounts[d.session_id] || 0) + 1;
            });
            const bounceSessions = Object.values(sessionCounts).filter(c => c === 1).length;
            const bounceRate = Object.keys(sessionCounts).length > 0 
                ? (bounceSessions / Object.keys(sessionCounts).length * 100).toFixed(1) 
                : 0;
            
            // Actualizar UI
            document.getElementById('stat-visits').textContent = totalVisits.toLocaleString();
            document.getElementById('stat-unique-visitors').textContent = uniqueVisitors.toLocaleString();
            document.getElementById('stat-pageviews').textContent = pageviews.toLocaleString();
            document.getElementById('stat-clicks').textContent = clicks.toLocaleString();
            document.getElementById('stat-avg-time').textContent = avgTime.toFixed(1) + ' min';
            document.getElementById('stat-bounce-rate').textContent = bounceRate + '%';
        }
        
        // Actualizar gr√°fico de d√≠as
        function updateDayChart(data) {
            const days = ['domingo', 'lunes', 'martes', 'miercoles', 'jueves', 'viernes', 'sabado'];
            const dayCounts = { lunes: 0, martes: 0, miercoles: 0, jueves: 0, viernes: 0, sabado: 0, domingo: 0 };
            
            data.forEach(d => {
                const dayIndex = new Date(d.created_at).getDay();
                const dayName = days[dayIndex];
                dayCounts[dayName]++;
            });
            
            const maxCount = Math.max(...Object.values(dayCounts), 1);
            
            Object.keys(dayCounts).forEach(day => {
                const bar = document.getElementById(`bar-${day}`);
                const count = document.getElementById(`count-${day}`);
                if (bar && count) {
                    const percentage = (dayCounts[day] / maxCount * 100).toFixed(0);
                    bar.style.width = percentage + '%';
                    count.textContent = dayCounts[day];
                }
            });
        }
        
        // Actualizar p√°ginas m√°s visitadas
        function updateTopPages(data) {
            const pageCounts = {};
            data.filter(d => d.event_type === 'pageview').forEach(d => {
                const page = d.page_url || d.page || 'Desconocida';
                pageCounts[page] = (pageCounts[page] || 0) + 1;
            });
            
            const sorted = Object.entries(pageCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);
            
            const container = document.getElementById('top-pages');
            
            if (sorted.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-4">No hay datos de p√°ginas</p>';
                return;
            }
            
            container.innerHTML = sorted.map(([page, count], index) => `
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                    <div class="flex items-center gap-3">
                        <span class="w-6 h-6 bg-amber-500 text-white rounded-full flex items-center justify-center text-sm font-bold">${index + 1}</span>
                        <span class="truncate max-w-[200px]">${page}</span>
                    </div>
                    <span class="font-bold text-amber-800">${count}</span>
                </div>
            `).join('');
        }
        
        // Actualizar estad√≠sticas de dispositivos
        function updateDeviceStats(data) {
            const devices = { mobile: 0, desktop: 0, tablet: 0 };
            
            data.forEach(d => {
                const device = (d.device_type || 'desktop').toLowerCase();
                if (device.includes('mobile') || device.includes('phone')) devices.mobile++;
                else if (device.includes('tablet') || device.includes('ipad')) devices.tablet++;
                else devices.desktop++;
            });
            
            const total = data.length || 1;
            
            document.getElementById('device-mobile').textContent = (devices.mobile / total * 100).toFixed(1) + '%';
            document.getElementById('device-mobile-count').textContent = `(${devices.mobile})`;
            document.getElementById('device-desktop').textContent = (devices.desktop / total * 100).toFixed(1) + '%';
            document.getElementById('device-desktop-count').textContent = `(${devices.desktop})`;
            document.getElementById('device-tablet').textContent = (devices.tablet / total * 100).toFixed(1) + '%';
            document.getElementById('device-tablet-count').textContent = `(${devices.tablet})`;
        }
        
        // Actualizar fuentes de tr√°fico
        function updateTrafficSources(data) {
            const sources = { organic: 0, direct: 0, social: 0, referral: 0 };
            
            data.forEach(d => {
                const source = (d.traffic_source || d.referrer || 'direct').toLowerCase();
                if (source.includes('google') || source.includes('bing') || source.includes('search')) sources.organic++;
                else if (source.includes('facebook') || source.includes('instagram') || source.includes('twitter') || source.includes('tiktok')) sources.social++;
                else if (source === 'direct' || source === '' || source === 'null') sources.direct++;
                else sources.referral++;
            });
            
            const total = data.length || 1;
            
            document.getElementById('source-organic').textContent = (sources.organic / total * 100).toFixed(1) + '%';
            document.getElementById('source-direct').textContent = (sources.direct / total * 100).toFixed(1) + '%';
            document.getElementById('source-social').textContent = (sources.social / total * 100).toFixed(1) + '%';
            document.getElementById('source-referral').textContent = (sources.referral / total * 100).toFixed(1) + '%';
        }
        
        // Actualizar actividad reciente
        function updateRecentActivity(data) {
            const container = document.getElementById('recent-activity');
            const recent = data.slice(0, 20);
            
            if (recent.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-4">No hay actividad reciente</p>';
                return;
            }
            
            container.innerHTML = recent.map(d => {
                const time = new Date(d.created_at).toLocaleString('es-ES', { 
                    hour: '2-digit', 
                    minute: '2-digit',
                    day: '2-digit',
                    month: '2-digit'
                });
                const icon = d.event_type === 'click' ? 'üëÜ' : d.event_type === 'pageview' ? 'üìÑ' : '‚ö°';
                const page = d.page_url || d.page || 'P√°gina desconocida';
                
                return `
                    <div class="flex items-center gap-3 p-2 hover:bg-gray-50 rounded-lg">
                        <span class="text-xl">${icon}</span>
                        <div class="flex-1 min-w-0">
                            <p class="text-sm font-medium truncate">${d.event_type}: ${page}</p>
                            <p class="text-xs text-gray-500">${d.device_type || 'Desktop'} ‚Ä¢ ${d.traffic_source || 'Directo'}</p>
                        </div>
                        <span class="text-xs text-gray-400 whitespace-nowrap">${time}</span>
                    </div>
                `;
            }).join('');
        }
        
        // Cargar conversiones
        async function loadConversions(dateRange) {
            try {
                // Contar pedidos
                const { data: orders, error: ordersError } = await supabaseClient
                    .from('orders')
                    .select('id')
                    .gte('created_at', dateRange.start)
                    .lte('created_at', dateRange.end);
                
                // Contar reservas
                const { data: reservas, error: reservasError } = await supabaseClient
                    .from('reservations')
                    .select('id')
                    .gte('created_at', dateRange.start)
                    .lte('created_at', dateRange.end);
                
                const totalOrders = orders?.length || 0;
                const totalReservas = reservas?.length || 0;
                const conversions = totalOrders + totalReservas;
                
                document.getElementById('stat-conversions').textContent = conversions;
                
                // Tasa de conversi√≥n
                const uniqueVisitors = parseInt(document.getElementById('stat-unique-visitors').textContent.replace(/,/g, '')) || 1;
                const conversionRate = (conversions / uniqueVisitors * 100).toFixed(2);
                document.getElementById('stat-conversion-rate').textContent = conversionRate + '%';
                
            } catch (err) {
                console.error('Error cargando conversiones:', err);
            }
        }
        
        // ==================== GESTI√ìN DE CLIENTES ====================
        
        let clients = [];
        let filteredClients = [];
        
        // Cargar clientes
        async function loadClients() {
            try {
                // Cargar clientes de la tabla clients
                const { data: clientsData, error } = await supabaseClient
                    .from('clients')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (error) {
                    console.error('Error cargando clientes:', error);
                    return;
                }
                
                clients = clientsData || [];
                filteredClients = [...clients];
                
                // Actualizar estad√≠sticas
                updateClientStats();
                
                // Renderizar lista
                renderClients();
                
            } catch (err) {
                console.error('Error en loadClients:', err);
            }
        }
        
        // Actualizar estad√≠sticas de clientes
        async function updateClientStats() {
            const total = clients.length;
            const thisMonth = new Date();
            thisMonth.setDate(1);
            thisMonth.setHours(0, 0, 0, 0);
            
            const nuevos = clients.filter(c => new Date(c.created_at) >= thisMonth).length;
            const conReservas = clients.filter(c => c.total_reservas > 0).length;
            const conPedidos = clients.filter(c => c.total_pedidos > 0).length;
            
            document.getElementById('stat-clientes-total').textContent = total;
            document.getElementById('stat-clientes-nuevos').textContent = nuevos;
            document.getElementById('stat-clientes-reservas').textContent = conReservas;
            document.getElementById('stat-clientes-pedidos').textContent = conPedidos;
        }
        
        // Renderizar lista de clientes
        function renderClients() {
            const container = document.getElementById('clients-list');
            
            if (filteredClients.length === 0) {
                container.innerHTML = `
                    <tr>
                        <td colspan="7" class="px-4 py-8 text-center text-gray-500">No hay clientes registrados.</td>
                    </tr>
                `;
                return;
            }
            
            container.innerHTML = filteredClients.map(client => `
                <tr class="border-b hover:bg-amber-50">
                    <td class="px-4 py-3">
                        <div class="font-medium text-gray-900">${client.nombre}</div>
                        ${client.notas ? `<div class="text-xs text-gray-500">${client.notas.substring(0, 50)}...</div>` : ''}
                    </td>
                    <td class="px-4 py-3">
                        <div class="text-sm">${client.email}</div>
                        <div class="text-xs text-gray-500">${client.telefono || '-'}</div>
                    </td>
                    <td class="px-4 py-3 text-center">
                        <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded-full text-sm">${client.total_reservas || 0}</span>
                    </td>
                    <td class="px-4 py-3 text-center">
                        <span class="bg-purple-100 text-purple-800 px-2 py-1 rounded-full text-sm">${client.total_pedidos || 0}</span>
                    </td>
                    <td class="px-4 py-3 text-center">
                        ${client.newsletter ? '<span class="text-green-600">‚úì Suscrito</span>' : '<span class="text-gray-400">No</span>'}
                    </td>
                    <td class="px-4 py-3 text-sm text-gray-500">
                        ${new Date(client.created_at).toLocaleDateString('es-ES')}
                    </td>
                    <td class="px-4 py-3 text-center">
                        <button onclick="editClient('${client.id}')" class="text-amber-600 hover:text-amber-800 mr-2" title="Editar">‚úèÔ∏è</button>
                        <button onclick="deleteClient('${client.id}')" class="text-red-600 hover:text-red-800" title="Eliminar">üóëÔ∏è</button>
                    </td>
                </tr>
            `).join('');
        }
        
        // Filtrar clientes
        function filterClients() {
            const search = document.getElementById('client-search').value.toLowerCase();
            const filter = document.getElementById('client-filter').value;
            
            filteredClients = clients.filter(client => {
                const matchesSearch = 
                    client.nombre.toLowerCase().includes(search) ||
                    client.email.toLowerCase().includes(search) ||
                    (client.telefono && client.telefono.includes(search));
                
                let matchesFilter = true;
                if (filter === 'with-reservations') matchesFilter = client.total_reservas > 0;
                if (filter === 'with-orders') matchesFilter = client.total_pedidos > 0;
                if (filter === 'subscribed') matchesFilter = client.newsletter === true;
                
                return matchesSearch && matchesFilter;
            });
            
            renderClients();
        }
        
        // Mostrar modal de cliente
        function showClientModal(clientId = null) {
            document.getElementById('client-modal').classList.remove('hidden');
            document.getElementById('client-form').reset();
            document.getElementById('client-id').value = '';
            document.getElementById('client-modal-title').textContent = 'Nuevo Cliente';
            document.getElementById('client-newsletter').checked = true;
            
            if (clientId) {
                const client = clients.find(c => c.id === clientId);
                if (client) {
                    document.getElementById('client-modal-title').textContent = 'Editar Cliente';
                    document.getElementById('client-id').value = client.id;
                    document.getElementById('client-nombre').value = client.nombre;
                    document.getElementById('client-email').value = client.email;
                    document.getElementById('client-telefono').value = client.telefono || '';
                    document.getElementById('client-direccion').value = client.direccion || '';
                    document.getElementById('client-notas').value = client.notas || '';
                    document.getElementById('client-newsletter').checked = client.newsletter;
                }
            }
        }
        
        function editClient(clientId) {
            showClientModal(clientId);
        }
        
        function closeClientModal() {
            document.getElementById('client-modal').classList.add('hidden');
        }
        
        // Guardar cliente
        document.getElementById('client-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const clientId = document.getElementById('client-id').value;
            const clientData = {
                nombre: document.getElementById('client-nombre').value,
                email: document.getElementById('client-email').value,
                telefono: document.getElementById('client-telefono').value || null,
                direccion: document.getElementById('client-direccion').value || null,
                notas: document.getElementById('client-notas').value || null,
                newsletter: document.getElementById('client-newsletter').checked
            };
            
            let error;
            
            if (clientId) {
                const result = await supabaseClient
                    .from('clients')
                    .update(clientData)
                    .eq('id', clientId);
                error = result.error;
            } else {
                clientData.total_reservas = 0;
                clientData.total_pedidos = 0;
                const result = await supabaseClient
                    .from('clients')
                    .insert([clientData]);
                error = result.error;
            }
            
            if (error) {
                alert('Error al guardar cliente: ' + error.message);
                return;
            }
            
            closeClientModal();
            loadClients();
        });
        
        // Eliminar cliente
        async function deleteClient(clientId) {
            if (!confirm('¬øEst√°s seguro de eliminar este cliente?')) return;
            
            const { error } = await supabaseClient
                .from('clients')
                .delete()
                .eq('id', clientId);
            
            if (error) {
                alert('Error al eliminar cliente: ' + error.message);
                return;
            }
            
            loadClients();
        }
        
        // Exportar a Excel
        function exportClientsExcel() {
            const data = filteredClients.map(c => ({
                'Nombre': c.nombre,
                'Email': c.email,
                'Tel√©fono': c.telefono || '',
                'Direcci√≥n': c.direccion || '',
                'Reservas': c.total_reservas || 0,
                'Pedidos': c.total_pedidos || 0,
                'Newsletter': c.newsletter ? 'S√≠' : 'No',
                'Fecha Registro': new Date(c.created_at).toLocaleDateString('es-ES'),
                'Notas': c.notas || ''
            }));
            
            // Crear CSV
            const headers = Object.keys(data[0] || {});
            const csv = [
                headers.join(','),
                ...data.map(row => headers.map(h => `"${(row[h] || '').toString().replace(/"/g, '""')}"`).join(','))
            ].join('\n');
            
            // Descargar
            const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `clientes_macondo_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
        }
        
        // Exportar a PDF
        function exportClientsPDF() {
            const printWindow = window.open('', '_blank');
            const logoUrl = 'favicon.png';
            
            const html = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Lista de Clientes - Macondo Bar Latino</title>
                    <style>
                        body { font-family: Arial, sans-serif; padding: 20px; }
                        .header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #d97706; padding-bottom: 20px; }
                        .header img { width: 80px; height: 80px; }
                        .header h1 { color: #92400e; margin: 10px 0 5px; }
                        .header p { color: #666; margin: 0; }
                        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                        th { background: #fef3c7; color: #92400e; padding: 10px; text-align: left; border: 1px solid #ddd; }
                        td { padding: 8px 10px; border: 1px solid #ddd; }
                        tr:nth-child(even) { background: #fafafa; }
                        .footer { margin-top: 30px; text-align: center; color: #666; font-size: 12px; }
                        @media print { body { padding: 0; } }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <img src="${logoUrl}" alt="Macondo Logo">
                        <h1>Macondo Bar Latino</h1>
                        <p>Lista de Clientes - Generado el ${new Date().toLocaleDateString('es-ES')}</p>
                    </div>
                    
                    <table>
                        <thead>
                            <tr>
                                <th>Nombre</th>
                                <th>Email</th>
                                <th>Tel√©fono</th>
                                <th>Reservas</th>
                                <th>Pedidos</th>
                                <th>Newsletter</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${filteredClients.map(c => `
                                <tr>
                                    <td>${c.nombre}</td>
                                    <td>${c.email}</td>
                                    <td>${c.telefono || '-'}</td>
                                    <td>${c.total_reservas || 0}</td>
                                    <td>${c.total_pedidos || 0}</td>
                                    <td>${c.newsletter ? 'S√≠' : 'No'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    
                    <div class="footer">
                        <p>Total de clientes: ${filteredClients.length}</p>
                        <p>Macondo Bar Latino - ul. Przyk≈Çadowa 123, Warszawa</p>
                    </div>
                    
                    <script>window.onload = function() { window.print(); }<\/script>
                </body>
                </html>
            `;
            
            printWindow.document.write(html);
            printWindow.document.close();
        }
        
        // ==================== EMAIL MARKETING ====================
        
        function showEmailMarketingModal() {
            document.getElementById('email-marketing-modal').classList.remove('hidden');
            document.getElementById('email-marketing-form').reset();
            
            // Contar destinatarios suscritos
            const subscribedCount = clients.filter(c => c.newsletter).length;
            document.getElementById('email-recipients-count').textContent = subscribedCount;
        }

        function openZohoInbox() {
            window.open('https://mail.zoho.eu/', '_blank', 'noopener,noreferrer');
        }
        
        function closeEmailMarketingModal() {
            document.getElementById('email-marketing-modal').classList.add('hidden');
        }
        
        // Actualizar plantilla seg√∫n tipo de campa√±a
        function updateEmailTemplate() {
            const type = document.getElementById('email-campaign-type').value;
            const subjectInput = document.getElementById('email-subject');
            const contentInput = document.getElementById('email-content');
            const preview = document.getElementById('email-preview');
            
            const templates = {
                'nuevo-plato': {
                    subject: 'üçΩÔ∏è ¬°Nuevo plato en Macondo Bar Latino!',
                    content: 'Hola,\n\nTenemos el placer de presentarte nuestro nuevo plato:\n\n[NOMBRE DEL PLATO]\n\n[DESCRIPCI√ìN]\n\nVen a probarlo y disfruta de los aut√©nticos sabores colombianos.\n\n¬°Te esperamos!\n\nMacondo Bar Latino'
                },
                'nuevo-evento': {
                    subject: 'üéâ ¬°Nuevo evento en Macondo Bar Latino!',
                    content: 'Hola,\n\nTe invitamos a nuestro pr√≥ximo evento:\n\n[NOMBRE DEL EVENTO]\nFecha: [FECHA]\nHora: [HORA]\n\n[DESCRIPCI√ìN]\n\nReserva tu mesa y no te lo pierdas.\n\n¬°Te esperamos!\n\nMacondo Bar Latino'
                },
                'promocion': {
                    subject: 'üè∑Ô∏è ¬°Promoci√≥n especial en Macondo Bar Latino!',
                    content: 'Hola,\n\nTenemos una promoci√≥n especial para ti:\n\n[NOMBRE DE LA PROMOCI√ìN]\n\n[DESCRIPCI√ìN Y CONDICIONES]\n\nV√°lido hasta: [FECHA]\n\n¬°No te lo pierdas!\n\nMacondo Bar Latino'
                },
                'newsletter': {
                    subject: 'üì∞ Novedades de Macondo Bar Latino',
                    content: 'Hola,\n\nTe traemos las √∫ltimas novedades de Macondo Bar Latino:\n\n[CONTENIDO]\n\nGracias por ser parte de nuestra familia.\n\n¬°Te esperamos pronto!\n\nMacondo Bar Latino'
                },
                'custom': {
                    subject: '',
                    content: ''
                }
            };
            
            if (templates[type]) {
                subjectInput.value = templates[type].subject;
                contentInput.value = templates[type].content;
                updateEmailPreview();
            }
        }
        
        // Actualizar vista previa
        function updateEmailPreview() {
            const subject = document.getElementById('email-subject').value;
            const content = document.getElementById('email-content').value;
            const preview = document.getElementById('email-preview');
            
            if (!subject && !content) {
                preview.innerHTML = '<p class="text-gray-400 italic">Selecciona un tipo de campa√±a para ver la vista previa...</p>';
                return;
            }
            
            preview.innerHTML = `
                <div style="border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 10px;">
                    <strong>Asunto:</strong> ${subject}
                </div>
                <div style="white-space: pre-wrap;">${content}</div>
            `;
        }
        
        // Escuchar cambios en el contenido
        document.getElementById('email-subject').addEventListener('input', updateEmailPreview);
        document.getElementById('email-content').addEventListener('input', updateEmailPreview);
        
        async function getAdminAccessToken() {
            try {
                const { data, error } = await supabaseClient.auth.getSession();
                if (error) return null;

                let session = data?.session || null;
                const expMs = session?.expires_at ? Number(session.expires_at) * 1000 : 0;
                if (session && expMs && expMs < Date.now() + 60 * 1000) {
                    const refreshed = await supabaseClient.auth.refreshSession();
                    session = refreshed?.data?.session || session;
                }

                return session?.access_token || null;
            } catch (e) {
                return null;
            }
        }

        async function loadCoverConfigAdmin() {
            const statusEl = document.getElementById('cover-config-status');
            if (statusEl) statusEl.textContent = 'Cargando...';

            try {
                const resp = await fetch('/.netlify/functions/cover-config', { method: 'GET' });
                const data = await resp.json().catch(() => ({}));
                if (!resp.ok) {
                    if (statusEl) statusEl.textContent = data.error || 'No se pudo cargar la configuraci√≥n.';
                    return;
                }

                const cfg = data.config || {};
                const dj = document.getElementById('cover-dj');
                const price = document.getElementById('cover-price');
                const active = document.getElementById('cover-active');

                if (dj) dj.value = cfg.dj_name || 'Dj Micke';
                if (price) price.value = Number(cfg.price_pln || 30);
                if (active) active.checked = cfg.active !== false;

                if (statusEl) statusEl.textContent = 'OK';
            } catch (e) {
                if (statusEl) statusEl.textContent = e.message || String(e);
            }
        }

        const coverConfigForm = document.getElementById('cover-config-form');
        if (coverConfigForm) {
            coverConfigForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const statusEl = document.getElementById('cover-config-status');
                if (statusEl) statusEl.textContent = 'Guardando...';

                const accessToken = await getAdminAccessToken();
                if (!accessToken) {
                    if (statusEl) statusEl.textContent = 'Sesi√≥n inv√°lida. Vuelve a iniciar sesi√≥n.';
                    return;
                }

                const dj_name = String(document.getElementById('cover-dj')?.value || '').trim();
                const price_pln = Number(document.getElementById('cover-price')?.value);
                const active = !!document.getElementById('cover-active')?.checked;

                try {
                    const resp = await fetch('/.netlify/functions/admin-cover-config', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': 'Bearer ' + accessToken
                        },
                        body: JSON.stringify({ dj_name, price_pln, active })
                    });

                    const data = await resp.json().catch(() => ({}));
                    if (!resp.ok) {
                        if (statusEl) statusEl.textContent = data.error || 'No se pudo guardar.';
                        return;
                    }

                    if (statusEl) statusEl.textContent = '‚úÖ Guardado';
                } catch (err) {
                    if (statusEl) statusEl.textContent = err.message || String(err);
                }
            });
        }

        async function loadStaffUsers() {
            const statusEl = document.getElementById('staff-users-status');
            const listEl = document.getElementById('staff-users-list');
            if (statusEl) statusEl.textContent = '';
            if (listEl) listEl.innerHTML = '<p class="text-gray-500">Cargando...</p>';

            const accessToken = await getAdminAccessToken();
            if (!accessToken) {
                if (statusEl) statusEl.textContent = 'Sesi√≥n inv√°lida. Vuelve a iniciar sesi√≥n.';
                if (listEl) listEl.innerHTML = '';
                return;
            }

            try {
                const resp = await fetch('/.netlify/functions/admin-staff-users', {
                    method: 'GET',
                    headers: { 'Authorization': 'Bearer ' + accessToken }
                });

                const data = await resp.json().catch(() => ({}));
                if (!resp.ok) {
                    if (statusEl) statusEl.textContent = data.error || 'No se pudo cargar.';
                    if (listEl) listEl.innerHTML = '';
                    return;
                }

                const staff = data.staff || [];
                if (!listEl) return;

                if (staff.length === 0) {
                    listEl.innerHTML = '<p class="text-gray-500">No hay usuarios staff.</p>';
                    return;
                }

                listEl.innerHTML = staff.map(s => `
                    <div class="p-3 border rounded-lg flex items-center justify-between gap-3">
                        <div>
                            <div class="font-bold text-amber-800">${s.username}</div>
                            <div class="text-sm text-gray-600">${s.active ? 'Activo' : 'Inactivo'}</div>
                        </div>
                        <div class="flex flex-wrap gap-2">
                            <button onclick="staffSetActive('${s.username}', ${s.active ? 'false' : 'true'})" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold px-3 py-2 rounded-lg">${s.active ? 'Desactivar' : 'Activar'}</button>
                            <button onclick="staffResetPin('${s.username}')" class="bg-amber-600 hover:bg-amber-700 text-white font-bold px-3 py-2 rounded-lg">Reset PIN</button>
                            <button onclick="staffDeleteUser('${s.username}')" class="bg-red-600 hover:bg-red-700 text-white font-bold px-3 py-2 rounded-lg">Eliminar</button>
                        </div>
                    </div>
                `).join('');
            } catch (err) {
                if (statusEl) statusEl.textContent = err.message || String(err);
                if (listEl) listEl.innerHTML = '';
            }
        }

        async function staffAction(action, payload) {
            const accessToken = await getAdminAccessToken();
            if (!accessToken) {
                alert('Sesi√≥n inv√°lida. Vuelve a iniciar sesi√≥n.');
                return false;
            }

            const resp = await fetch('/.netlify/functions/admin-staff-users', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + accessToken
                },
                body: JSON.stringify({ action, ...payload })
            });

            const data = await resp.json().catch(() => ({}));
            if (!resp.ok) {
                alert(data.error || 'Error');
                return false;
            }
            return true;
        }

        async function staffResetPin(username) {
            const pin = prompt('Nuevo PIN para ' + username + ':');
            if (!pin) return;
            const ok = await staffAction('reset_pin', { username, pin });
            if (ok) {
                await loadStaffUsers();
                alert('‚úÖ PIN actualizado');
            }
        }

        async function staffDeleteUser(username) {
            if (!confirm('¬øEliminar usuario staff ' + username + '?')) return;
            const ok = await staffAction('delete', { username });
            if (ok) {
                await loadStaffUsers();
            }
        }

        async function staffSetActive(username, active) {
            const ok = await staffAction('set_active', { username, active });
            if (ok) {
                await loadStaffUsers();
            }
        }

        const staffCreateForm = document.getElementById('staff-create-form');
        if (staffCreateForm) {
            staffCreateForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const username = String(document.getElementById('staff-username')?.value || '').trim();
                const pin = String(document.getElementById('staff-pin')?.value || '').trim();
                if (!username || !pin) return;

                const ok = await staffAction('create', { username, pin });
                if (ok) {
                    staffCreateForm.reset();
                    await loadStaffUsers();
                    alert('‚úÖ Usuario staff creado');
                }
            });
        }

        async function clearAnalytics() {
            if (!confirm('¬øSeguro que quieres borrar TODOS los registros de anal√≠ticas?')) return;

            const accessToken = await getAdminAccessToken();
            if (!accessToken) {
                alert('Tu sesi√≥n no es v√°lida. Vuelve a iniciar sesi√≥n en el panel admin.');
                return;
            }

            try {
                const resp = await fetch('/.netlify/functions/clear-analytics', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + accessToken
                    },
                    body: JSON.stringify({})
                });

                const data = await resp.json().catch(() => ({}));
                if (!resp.ok) {
                    alert('Error limpiando anal√≠ticas: ' + (data.error || resp.statusText));
                    return;
                }

                alert('‚úÖ Anal√≠ticas borradas.');
                await loadAnalytics();
            } catch (e) {
                alert('Error limpiando anal√≠ticas: ' + (e.message || e));
            }
        }
        
        // Enviar email de prueba
        async function sendTestEmail() {
            const subject = document.getElementById('email-subject').value;
            const content = document.getElementById('email-content').value;
            
            if (!subject || !content) {
                alert('Por favor completa el asunto y contenido del email.');
                return;
            }
            
            const testEmail = prompt('Ingresa tu email para recibir la prueba:');
            if (!testEmail) return;
            
            const accessToken = await getAdminAccessToken();
            if (!accessToken) {
                alert('Tu sesi√≥n no es v√°lida. Vuelve a iniciar sesi√≥n en el panel admin.');
                return;
            }
            
            try {
                const resp = await fetch('/.netlify/functions/send-email', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + accessToken
                    },
                    body: JSON.stringify({
                        mode: 'test',
                        testEmail,
                        subject,
                        content
                    })
                });
                
                const data = await resp.json().catch(() => ({}));
                if (!resp.ok) {
                    alert('Error enviando prueba: ' + (data.error || resp.statusText));
                    return;
                }
                
                alert('‚úÖ Email de prueba enviado a: ' + testEmail);
            } catch (e) {
                alert('Error enviando prueba: ' + (e.message || e));
            }
        }
        
        // Enviar campa√±a de email
        document.getElementById('email-marketing-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const subject = document.getElementById('email-subject').value;
            const content = document.getElementById('email-content').value;
            const recipients = clients.filter(c => c.newsletter);
            
            if (recipients.length === 0) {
                alert('No hay clientes suscritos para enviar el email.');
                return;
            }
            
            if (!confirm(`¬øEst√°s seguro de enviar este email a ${recipients.length} clientes?`)) {
                return;
            }
            
            const accessToken = await getAdminAccessToken();
            if (!accessToken) {
                alert('Tu sesi√≥n no es v√°lida. Vuelve a iniciar sesi√≥n en el panel admin.');
                return;
            }
            
            try {
                const resp = await fetch('/.netlify/functions/send-email', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + accessToken
                    },
                    body: JSON.stringify({
                        mode: 'campaign',
                        subject,
                        content,
                        campaignType: document.getElementById('email-campaign-type').value
                    })
                });
                
                const data = await resp.json().catch(() => ({}));
                if (!resp.ok) {
                    alert('Error enviando campa√±a: ' + (data.error || resp.statusText));
                    return;
                }
                
                alert(`‚úÖ Campa√±a enviada. Total: ${data.totalRecipients || 0}, Enviados: ${data.sent || 0}, Fallos: ${data.failures || 0}`);
                closeEmailMarketingModal();
            } catch (e) {
                alert('Error enviando campa√±a: ' + (e.message || e));
            }
        });
    </script>
</body>
</html>
